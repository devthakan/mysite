<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Member Admin – Add Membership</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- NOTE: defer हटाया ताकि Supabase लाइब्रेरी पहले लोड हो जाए -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { background:#0f172a; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.08); }
    .hidden { display:none; }
    .ok { color:#86efac }
    .bad { color:#fca5a5 }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="max-w-3xl mx-auto p-4 md:p-8">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-white">Member Admin – Add Membership</h1>
      <p class="text-slate-300 mt-1">किस तालिका में लिखना/पढ़ना है — ऊपर constants से नियंत्रित करें</p>
    </header>

    <!-- Connection / Diagnostics -->
    <section class="glass rounded-2xl p-4 md:p-6 border border-white/10 mb-6 text-sm">
      <div>Project URL: <span id="u" class="mono"></span></div>
      <div>Schema: <span id="s" class="mono"></span> | Table: <span id="t" class="mono"></span></div>
      <div>Status: <span id="status" class="mono">—</span></div>
      <div class="mt-2">
        <button id="btn_check" class="px-3 py-2 rounded-lg bg-slate-700">Check Setup</button>
        <span id="diag" class="ml-2 text-slate-300"></span>
      </div>
    </section>

    <section class="glass rounded-2xl p-4 md:p-6 border border-white/10 mb-8">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm mb-1">सदस्यता संख्या</label>
          <input id="m_no" inputmode="numeric" pattern="\d{1,12}" maxlength="12" class="w-full bg-slate-800/70 border border-white/10 rounded-xl p-3" placeholder="उदा. 123456" required />
        </div>
        <div>
          <label class="block text-sm mb-1">कृषक का नाम</label>
          <input id="m_name" class="w-full bg-slate-800/70 border border-white/10 rounded-xl p-3 uppercase" pattern="[A-Z ]+" required oninput="this.value=this.value.toUpperCase().replace(/[^A-Z ]/g,'')" />
        </div>
        <div>
          <label class="block text-sm mb-1">पिता/पति का नाम</label>
          <input id="m_father" class="w-full bg-slate-800/70 border border-white/10 rounded-xl p-3 uppercase" pattern="[A-Z ]+" required oninput="this.value=this.value.toUpperCase().replace(/[^A-Z ]/g,'')" />
        </div>
      </div>
      <div class="mt-4 flex gap-3 items-center">
        <button id="btn_add" class="px-5 py-3 rounded-xl bg-emerald-500 text-slate-900 font-semibold">Add Member</button>
        <span id="msg" class="text-slate-300"></span>
      </div>
      <pre id="err" class="mt-3 text-xs text-red-300 whitespace-pre-wrap"></pre>
    </section>

    <section class="glass rounded-2xl p-4 md:p-6 border border-white/10">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Recent Members</h2>
        <button id="refresh" class="px-3 py-2 rounded-lg bg-slate-700">Refresh</button>
      </div>
      <div id="list" class="text-slate-200 text-sm"></div>
    </section>
  </div>

  <script>
    // ⬇️ अपनी असली keys डालें
    const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co"; // <-- यहाँ बदलें
    const SUPABASE_KEY = "    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";                    // <-- यहाँ बदलें";                    // <-- यहाँ बदलें

    // ⬇️ यहाँ से table चुनेँ
    const SCHEMA = 'public';          // यदि अलग schema है तो बदलें
    const MEMBERS_TABLE = 'members';  // इसी नाम की तालिका में insert/select होगा

    const $=id=>document.getElementById(id);
    $('u').textContent = SUPABASE_URL;
    $('s').textContent = SCHEMA;
    $('t').textContent = MEMBERS_TABLE;

    let sb = null; // Supabase client

    function showErr(e){
      const msg = e?.message || e?.error?.message || (typeof e==='string'? e : JSON.stringify(e, null, 2));
      $('err').textContent = msg || '';
      console.error(e);
    }

    function tbl(){
      if(!sb){ throw new Error('Supabase client not ready'); }
      if(SCHEMA && SCHEMA !== 'public' && sb.schema){
        return sb.schema(SCHEMA).from(MEMBERS_TABLE);
      }
      return sb.from(MEMBERS_TABLE);
    }

    async function checkSetup(){
      $('diag').textContent = 'Checking…';
      $('err').textContent = '';
      if(!sb){ $('diag').innerHTML = '<span class="bad">Client not ready</span>'; return; }
      try{
        const sel = await tbl().select('membership_no', { count:'exact', head:true }).limit(1);
        if(sel.error){
          $('diag').innerHTML = '<span class="bad">SELECT failed</span>';
          showErr(sel.error);
          hintFromError(sel.error, 'select');
          return;
        }
        const testId = 'TEST_'+Date.now();
        const ins = await tbl().insert({ membership_no:testId, farmer_name:'TEST', guardian_name:'TEST' });
        if(ins.error){
          $('diag').innerHTML = '<span class="bad">INSERT failed</span>';
          showErr(ins.error);
          hintFromError(ins.error, 'insert');
          return;
        }
        await tbl().delete().eq('membership_no', testId);
        $('diag').innerHTML = '<span class="ok">OK: table + policies working</span>';
      }catch(e){
        $('diag').innerHTML = '<span class="bad">Check error</span>';
        showErr(e);
      }
    }

    function hintFromError(error, phase){
      const m = (error?.message||'').toLowerCase();
      const d = $('err');
      let tips = [];
      if(m.includes('permission denied') || m.includes('row-level security')){
        tips.push('✔ RLS policy allow करें (schema '+SCHEMA+', table '+MEMBERS_TABLE+'):');
        tips.push("SQL →\n  alter table "+MEMBERS_TABLE+" enable row level security;\n  create policy 'members_select' on "+MEMBERS_TABLE+" for select using (true);\n  create policy 'members_insert' on "+MEMBERS_TABLE+" for insert with check (true);");
      }
      if(m.includes('relation') && m.includes('does not exist')){
        tips.push('✔ Table बनाइए:');
        tips.push("SQL →\n  create table if not exists "+MEMBERS_TABLE+" (\n    membership_no text primary key,\n    farmer_name text,\n    guardian_name text\n  );");
      }
      if(m.includes('jwt') || m.includes('invalid token') || m.includes('anonymous')){
        tips.push('✔ URL/ANON KEY चेक करें (Project Settings → API).');
      }
      if(!tips.length){
        tips.push('✔ URL/KEY सही हैं? ✔ Table/columns नाम match कर रहे हैं? ✔ CSV/insert ठीक हुआ?');
      }
      d.textContent += '\n\nTips:\n' + tips.join('\n');
    }

    async function addMember(){
      $('msg').textContent=''; $('err').textContent='';
      if(!sb){ $('msg').textContent='Client not ready'; return; }
      const membership_no = $('m_no').value.trim();
      const farmer_name = $('m_name').value.trim().toUpperCase();
      const guardian_name = $('m_father').value.trim().toUpperCase();
      if(!membership_no || !farmer_name || !guardian_name){ $('msg').textContent='कृपया सभी फील्ड भरें'; return; }

      try{
        const ex = await tbl().select('membership_no').eq('membership_no', membership_no).maybeSingle();
        if(ex.error){ showErr(ex.error); hintFromError(ex.error, 'select'); return; }
        if(ex.data){ $('msg').textContent='यह सदस्य संख्या पहले से मौजूद है'; return; }

        const ins = await tbl().insert({ membership_no, farmer_name, guardian_name });
        if(ins.error){ showErr(ins.error); hintFromError(ins.error, 'insert'); return; }

        $('msg').textContent='जोड़ा गया ✔';
        $('m_no').value=''; $('m_name').value=''; $('m_father').value='';
        loadMembers();
      }catch(e){ showErr(e); }
    }

    async function loadMembers(){
      $('list').textContent = 'Loading…'; $('err').textContent='';
      if(!sb){ $('list').textContent='Client not ready'; return; }
      try{
        const q = await tbl()
          .select('membership_no, farmer_name, guardian_name')
          .order('membership_no', { ascending: true })
          .limit(20);
        if(q.error){ showErr(q.error); hintFromError(q.error, 'select'); $('list').textContent='Load error'; return; }
        const data = q.data || [];
        if(!data.length){ $('list').textContent='कोई रिकॉर्ड नहीं'; return; }
        const rows = data.map(r=>`<div class="flex justify-between border-b border-white/10 py-2"><span>#${r.membership_no}</span><span>${r.farmer_name}</span><span>${r.guardian_name}</span></div>`).join('');
        $('list').innerHTML = rows;
      }catch(e){ showErr(e); $('list').textContent='Load error'; }
    }

    // Bootstrap after page ready AND library present
    (function bootstrap(){
      const init = () => {
        try {
          if(!window.supabase || !window.supabase.createClient){
            $('status').textContent = 'Supabase JS not loaded';
            $('status').className = 'bad mono';
            return;
          }
          sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          $('status').textContent = 'Client init ✔';
          $('status').className = 'ok mono';

          // Bind handlers after client ready
          $('btn_check').addEventListener('click', checkSetup);
          $('btn_add').addEventListener('click', addMember);
          $('refresh').addEventListener('click', loadMembers);

          // Initial actions
          checkSetup();
          loadMembers();
        } catch (e) {
          $('status').textContent = 'Client init FAILED';
          $('status').className = 'bad mono';
          showErr(e);
        }
      };

      if(document.readyState === 'complete' || document.readyState === 'interactive'){
        // थोड़ी देर दें कि external script load हो जाए
        setTimeout(init, 0);
      } else {
        window.addEventListener('DOMContentLoaded', init);
      }
    })();
  </script>
</body>
</html>
