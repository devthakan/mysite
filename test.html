<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>बकाया रिकवरी सूची</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #login-section, #recovery-section { max-width: 800px; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .update-form { margin-top: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="login-section">
        <h2>लॉगिन करें</h2>
        <form id="login-form">
            <label for="email">ईमेल:</label>
            <input type="email" id="email" required>
            <br><br>
            <label for="password">पासवर्ड:</label>
            <input type="password" id="password" required>
            <br><br>
            <button type="submit">लॉगिन</button>
        </form>
    </div>

    <div id="recovery-section" class="hidden">
        <h2>बकाया किसानों की रिकवरी सूची</h2>
        <button id="logout-button">लॉगआउट</button>
        <table id="recovery-table">
            <thead>
                <tr>
                    <th>क्र.सं.</th>
                    <th>आधार नंबर</th>
                    <th>नाम</th>
                    <th>पिता का नाम</th>
                    <th>खाता संख्या</th>
                    <th>राशि</th>
                    <th>ब्याज</th>
                    <th>DMR नंबर</th>
                    <th>वर्ष</th>
                    <th>रिकवरी हुई?</th>
                    <th>कार्यवाही</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <div class="update-form">
            <h3>रिकवरी अपडेट करें</h3>
            <form id="update-form">
                <input type="hidden" id="update-sn">
                <label for="recovery_done">रिकवरी हुई (हाँ/नहीं):</label>
                <input type="text" id="recovery_done" required>
                <br><br>
                <button type="submit">अपडेट करें</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sjfglhxjdyvcygunijvz.supabase.co'; // यहाँ अपनी Supabase URL डालें
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM'; // यहाँ अपनी Supabase anon key डालें

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const loginSection = document.getElementById('login-section');
        const recoverySection = document.getElementById('recovery-section');
        const loginForm = document.getElementById('login-form');
        const logoutButton = document.getElementById('logout-button');
        const recoveryTableBody = document.querySelector('#recovery-table tbody');
        const updateForm = document.getElementById('update-form');
        const updateSn = document.getElementById('update-sn');
        const recoveryDoneInput = document.getElementById('recovery_done');

        // लॉगिन जांचें
        const checkUser = async () => {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                loginSection.classList.add('hidden');
                recoverySection.classList.remove('hidden');
                fetchRecoveryData();
            } else {
                loginSection.classList.remove('hidden');
                recoverySection.classList.add('hidden');
            }
        };

        // लॉगिन
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                alert('लॉगिन विफल: ' + error.message);
            } else {
                checkUser();
            }
        });

        // लॉगआउट
        logoutButton.addEventListener('click', async () => {
            await supabase.auth.signOut();
            checkUser();
        });

        // रिकवरी डेटा प्राप्त करें
        const fetchRecoveryData = async () => {
            const { data, error } = await supabase
                .from('recovrybakimember')
                .select('*');

            if (error) {
                console.error('डेटा लाने में त्रुटि:', error);
                return;
            }

            recoveryTableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.sn}</td>
                    <td>${row.adhar_number}</td>
                    <td>${row.name}</td>
                    <td>${row.father_name}</td>
                    <td>${row.account_number}</td>
                    <td>${row.amount}</td>
                    <td>${row.intrestdmr_number}</td>
                    <td>${row.year}</td>
                    <td>${row.recovery_done}</td>
                    <td><button onclick="editRecovery(${row.sn}, '${row.recovery_done}')">संपादित करें</button></td>
                `;
                recoveryTableBody.appendChild(tr);
            });
        };

        // संपादन के लिए फॉर्म भरें
        window.editRecovery = (sn, recovery_done) => {
            updateSn.value = sn;
            recoveryDoneInput.value = recovery_done;
        };

        // रिकवरी अपडेट करें
        updateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sn = updateSn.value;
            const recovery_done = recoveryDoneInput.value;

            const { error } = await supabase
                .from('recovrybakimember')
                .update({ recovery_done })
                .eq('sn', sn);

            if (error) {
                alert('अपडेट करने में त्रुटि: ' + error.message);
            } else {
                alert('रिकवरी सफलतापूर्वक अपडेट की गई!');
                fetchRecoveryData();
                updateForm.reset();
            }
        });

        checkUser();
    </script>

</body>
</html>
