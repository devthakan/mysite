<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{font-family:sans-serif;margin:0;background:#f9fafb}
    header{background:#4f46e5;color:#fff;padding:12px;display:flex;justify-content:space-between;align-items:center}
    #loginBox{display:none;background:#fff;padding:12px;border:1px solid #ddd;margin:10px auto;width:280px}
    table{width:95%;margin:15px auto;border-collapse:collapse;background:#fff}
    th,td{border:1px solid #eee;padding:8px;text-align:center}
    .btn{padding:6px 10px;border:none;border-radius:5px;cursor:pointer;color:#fff}
    .btn-add{background:#22c55e} .btn-edit{background:#3b82f6} .btn-del{background:#ef4444} .btn-done{background:#f59e0b}
    #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);justify-content:center;align-items:center}
    #modalContent{background:#fff;padding:15px;border-radius:8px;width:300px}
    input,select{width:100%;margin:5px 0;padding:6px}
  </style>
</head>
<body>
<header>
  <h2>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</h2>
  <div>
    <span id="authStatus">üîí</span>
    <button id="loginToggle">üîë</button>
  </div>
</header>

<div id="loginBox">
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Password"><br>
  <button id="loginBtn">Login</button>
  <button id="logoutBtn" style="display:none">Logout</button>
</div>

<div style="text-align:right;width:95%;margin:auto">
  <button id="addBtn" class="btn btn-add" style="display:none">+ ‡§®‡§Ø‡§æ</button>
</div>

<table>
  <thead><tr>
    <th>ID</th><th>‡§Ü‡§ß‡§æ‡§∞</th><th>‡§®‡§æ‡§Æ</th><th>‡§∞‡§æ‡§∂‡§ø</th><th>‡§µ‡§∞‡•ç‡§∑</th><th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>

<div id="modal">
  <div id="modalContent">
    <input id="m_id" type="hidden">
    <input id="m_adhar" placeholder="‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞">
    <input id="m_name" placeholder="‡§®‡§æ‡§Æ">
    <input id="m_amt" type="number" placeholder="‡§∞‡§æ‡§∂‡§ø">
    <input id="m_year" type="number" placeholder="‡§µ‡§∞‡•ç‡§∑">
    <select id="m_done"><option value="false">Pending</option><option value="true">Done</option></select>
    <button id="saveBtn" class="btn btn-add">‡§∏‡•á‡§µ</button>
    <button id="cancelBtn">‡§∞‡§¶‡•ç‡§¶</button>
  </div>
</div>

<script>
const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user=null, mode="create";

function showModal(row={}){
  mode = row.id ? "edit" : "create";
  document.getElementById("m_id").value = row.id||"";
  document.getElementById("m_adhar").value = row.adhar_number||"";
  document.getElementById("m_name").value = row.name||"";
  document.getElementById("m_amt").value = row.amount||"";
  document.getElementById("m_year").value = row.year||"";
  document.getElementById("m_done").value = row.recovery_done?"true":"false";
  document.getElementById("modal").style.display="flex";
}
function closeModal(){ document.getElementById("modal").style.display="none"; }

async function loadData(){
  const { data,error } = await sb.from("recovrybakimember").select("*").order("id");
  if(error) return alert(error.message);
  const tb = document.getElementById("tbody"); tb.innerHTML="";
  (data||[]).forEach(r=>{
    tb.innerHTML += `<tr>
      <td>${r.id}</td><td>${r.adhar_number||""}</td><td>${r.name||""}</td>
      <td>${r.amount||""}</td><td>${r.year||""}</td>
      <td>${r.recovery_done?"‚úîÔ∏è":"‚è≥"}</td>
      <td>${user?`
        <button class="btn btn-edit" onclick='editRow(${r.id})'>Edit</button>
        <button class="btn btn-del" onclick='delRow(${r.id})'>Del</button>
        <button class="btn btn-done" onclick='doneRow(${r.id})'>Done</button>`:"üîí"}</td></tr>`;
  });
}

async function saveRow(){
  const row={
    adhar_number: m_adhar.value.trim(),
    name: m_name.value.trim(),
    amount: Number(m_amt.value)||0,
    year: Number(m_year.value)||null,
    recovery_done: m_done.value==="true"
  };
  try{
    if(mode==="create") await sb.from("recovrybakimember").insert(row);
    else await sb.from("recovrybakimember").update(row).eq("id", m_id.value);
    closeModal(); loadData();
  }catch(e){ alert(e.message); }
}

async function editRow(id){
  const { data } = await sb.from("recovrybakimember").select("*").eq("id",id).single();
  showModal(data);
}
async function delRow(id){
  if(confirm("‡§π‡§ü‡§æ‡§è‡§Å?")){ await sb.from("recovrybakimember").delete().eq("id",id); loadData(); }
}
async function doneRow(id){
  await sb.from("recovrybakimember").update({recovery_done:true}).eq("id",id); loadData();
}

async function doLogin(){
  const { data,error } = await sb.auth.signInWithPassword({email:email.value,password:password.value});
  if(error) return alert(error.message);
  user=data.user; setUI(); loadData();
}
async function doLogout(){
  await sb.auth.signOut(); user=null; setUI(); loadData(); location.reload();
}
function setUI(){
  authStatus.textContent = user?"‚úÖ":"üîí";
  addBtn.style.display = user?"inline-block":"none";
  logoutBtn.style.display = user?"inline-block":"none";
}

loginToggle.onclick=()=>loginBox.style.display=loginBox.style.display==="block"?"none":"block";
loginBtn.onclick=doLogin; logoutBtn.onclick=doLogout;
addBtn.onclick=()=>showModal();
saveBtn.onclick=saveRow; cancelBtn.onclick=closeModal;

(async()=>{
  const { data:{session} }=await sb.auth.getSession();
  user=session?.user||null; setUI(); loadData();
})();
</script>
</body>
</html>
