<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b1020; --card:#11172b; --muted:#8fa0c6; --pri:#6c8cff; --pri2:#94a9ff;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --border:#1f2a44;
    }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430 60%,#0b1020);
    font-family:'Inter','Noto Sans Devanagari',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; color:#eaf0ff}
    header{position:sticky;top:0;z-index:1000;background:rgba(11,16,32,.75);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:14px 18px}
    .title{display:flex;gap:10px;align-items:center}.logoDot{width:10px;height:10px;border-radius:50%;background:var(--pri);box-shadow:0 0 16px var(--pri2)}
    .title h2{margin:0;font-size:20px}.right{display:flex;gap:10px;align-items:center}
    #authStatus{font-size:18px}
    #emailBadge{display:none;font-size:12px;padding:4px 10px;border-radius:999px;background:rgba(148,169,255,.15);color:var(--pri2);border:1px solid rgba(148,169,255,.35)}
    #loginToggleBtn{border:1px solid rgba(148,169,255,.35);background:linear-gradient(180deg,rgba(148,169,255,.25),rgba(148,169,255,.1));
      color:var(--pri2);width:40px;height:40px;border-radius:12px;display:grid;place-items:center;cursor:pointer;font-size:18px;font-weight:700;
      transition:.2s transform ease,.2s box-shadow ease;box-shadow:0 10px 25px rgba(108,140,255,.15),inset 0 0 0 1px rgba(108,140,255,.1)}
    #loginToggleBtn:hover{transform:translateY(-1px)}
    .container{max-width:1200px;margin:18px auto;padding:0 12px}

    /* Login box */
    #loginBox{display:none;width:min(380px,92%);margin:16px 0 0 auto;background:linear-gradient(180deg,#0f1833,#0d152e);
      border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(108,140,255,.06)}
    #loginBox h3{margin:6px 0 10px;font-size:16px}
    #loginBox input{width:100%;padding:12px;margin:6px 0 10px;border-radius:10px;border:1px solid var(--border);background:#0b1328;color:#eaf0ff;outline:none}
    #loginBox button{width:100%;padding:12px;border:none;border-radius:10px;cursor:pointer;background:linear-gradient(180deg,var(--pri),#5576ff);color:#fff;font-weight:600;box-shadow:0 10px 25px rgba(108,140,255,.25)}
    #logoutBtn{display:none;margin-top:8px;background:linear-gradient(180deg,#d34,#b22)}
    #loginBox small{color:var(--muted)}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin:14px 0}
    .btn{padding:10px 12px;border:none;border-radius:10px;cursor:pointer;color:#fff;font-weight:600;border:1px solid rgba(255,255,255,.08)}
    .btn-refresh{background:linear-gradient(180deg,#3db2ff,#2b93e6)}
    .btn-add{background:linear-gradient(180deg,#22c55e,#16a34a);display:none}
    .btn-logout{background:linear-gradient(180deg,#ef4444,#dc2626);display:none}

    /* Card + Table */
    .card{background:linear-gradient(180deg,#0f1833,#0d152e);border:1px solid var(--border);border-radius:16px;overflow:hidden;
      box-shadow:0 20px 60px rgba(0,0,0,.45),inset 0 0 0 1px rgba(108,140,255,.06)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:center}
    th{background:linear-gradient(180deg,rgba(148,169,255,.12),rgba(148,169,255,.06));color:#dbe4ff;font-weight:700}
    td{color:#eaf0ff}
    .badge{padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
    .pending{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.35)}
    .done{background:rgba(34,197,94,.12);color:#34d399;border:1px solid rgba(34,197,94,.35)}
    .action{padding:7px 10px;border:none;border-radius:10px;margin:2px;cursor:pointer;color:#fff;font-weight:600;border:1px solid rgba(255,255,255,.08)}
    .edit-btn{background:linear-gradient(180deg,#3b82f6,#2563eb)} .delete-btn{background:linear-gradient(180deg,#ef4444,#dc2626)} .done-btn{background:linear-gradient(180deg,#f59e0b,#d97706)}
    .locked{color:var(--muted)}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(5,9,20,.6);display:none;align-items:center;justify-content:center;z-index:1100;pointer-events:none;backdrop-filter: blur(4px)}
    .modal-backdrop.active{display:flex;pointer-events:auto}
    .modal{width:min(760px,94%);background:linear-gradient(180deg,#101a37,#0f1833);border:1px solid var(--border);border-radius:16px;overflow:hidden;
      box-shadow:0 25px 80px rgba(0,0,0,.55),inset 0 0 0 1px rgba(108,140,255,.06)}
    .modal header{background:linear-gradient(180deg,rgba(148,169,255,.14),rgba(148,169,255,.08));padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal .content{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .col{display:flex;flex-direction:column}
    .col label{color:#cbd5ff;margin-bottom:6px;font-size:13px}
    .col input,.col select{padding:11px;border-radius:10px;border:1px solid var(--border);background:#0b1328;color:#eaf0ff;outline:none}
    .modal .actions{display:flex;gap:12px;justify-content:flex-end;padding:14px 16px;border-top:1px solid var(--border);background:rgba(0,0,0,.2)}
    .btn-secondary{background:linear-gradient(180deg,#6b7280,#4b5563)}
    @media (max-width:760px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <div class="title"><div class="logoDot"></div><h2>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</h2></div>
    <div class="right">
      <span id="authStatus" title="Auth Status">üîí</span>
      <span id="emailBadge"></span>
      <button id="loginToggleBtn" type="button" title="Login">üîë</button>
    </div>
  </header>

  <div class="container">
    <!-- Login panel -->
    <div id="loginBox" aria-hidden="true">
      <h3>‡§≤‡•â‡§ó-‡§á‡§®</h3>
      <form id="loginForm">
        <input type="email" id="email" placeholder="‡§à‡§Æ‡•á‡§≤" required />
        <input type="password" id="password" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" required />
        <button id="loginBtn" type="submit">‡§≤‡•â‡§ó-‡§á‡§®</button>
      </form>
      <small>Signup ‡§¨‡§Ç‡§¶ ‡§π‡•à ‚Äî ‡§ï‡•á‡§µ‡§≤ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ users login ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§</small>
      <button id="logoutBtn">‡§≤‡•â‡§ó-‡§Ü‡§â‡§ü</button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button class="btn btn-refresh" type="button" id="refreshBtn">Refresh</button>
      <button id="addBtn" class="btn btn-add" type="button">+ ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</button>
      <button id="topLogoutBtn" class="btn btn-logout" type="button">Logout</button>
    </div>

    <!-- Table Card -->
    <div class="card">
      <table id="dataTable">
        <thead>
          <tr>
            <th>S.N.</th>
            <th>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞</th>
            <th>‡§®‡§æ‡§Æ</th>
            <th>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
            <th>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞</th>
            <th>‡§∞‡§æ‡§∂‡§ø</th>
            <th>DMR ‡§®‡§Ç‡§¨‡§∞</th>
            <th>‡§µ‡§∞‡•ç‡§∑</th>
            <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
            <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="backdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <header><strong id="modalTitle">‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</strong></header>
      <div class="content">
        <input type="hidden" id="rowId" />
        <div class="grid">
          <div class="col"><label>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞ (12 ‡§Ö‡§Ç‡§ï)</label><input id="f_adhar" maxlength="12" placeholder="123456789012" /></div>
          <div class="col"><label>‡§®‡§æ‡§Æ</label><input id="f_name" /></div>
          <div class="col"><label>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label><input id="f_father" /></div>
          <div class="col"><label>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞</label><input id="f_account" maxlength="20" /></div>
          <div class="col"><label>‡§∞‡§æ‡§∂‡§ø</label><input id="f_amount" type="number" step="0.01" /></div>
          <div class="col"><label>DMR ‡§®‡§Ç‡§¨‡§∞</label><input id="f_dmr" /></div>
          <div class="col"><label>‡§µ‡§∞‡•ç‡§∑</label><input id="f_year" type="number" placeholder="2025" /></div>
          <div class="col"><label>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
            <select id="f_done"><option value="false">Pending</option><option value="true">Done</option></select>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-secondary" type="button" id="cancelBtn">‡§∞‡§¶‡•ç‡§¶</button>
        <button id="saveBtn" class="btn btn-add" type="button">üíæ ‡§∏‡•á‡§µ</button>
      </div>
    </div>
  </div>

<script>
  // ------- CONFIG -------
  const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey:"recovrybakimember-auth-v1" }
  });

  // ------- STATE -------
  let currentUser = null;
  let editMode = 'create'; // 'create' | 'edit'
  let busy = false;        // global debounce

  // ------- HELPERS -------
  const $ = s => document.querySelector(s);
  function setAuthUI(){
    const isLogged = !!currentUser;
    $('#authStatus').textContent = isLogged ? '‚úÖ' : 'üîí';
    $('#addBtn').style.display = isLogged ? 'inline-block' : 'none';
    $('#topLogoutBtn').style.display = isLogged ? 'inline-block' : 'none';
    $('#logoutBtn').style.display = isLogged ? 'block' : 'none';
    const badge = $('#emailBadge');
    if(isLogged && currentUser.email){ badge.textContent = currentUser.email; badge.style.display = 'inline-block'; }
    else { badge.style.display = 'none'; }
  }
  function toggleLogin(){
    const box = $('#loginBox');
    const visible = box.style.display === 'block';
    box.style.display = visible ? 'none' : 'block';
    box.setAttribute('aria-hidden', visible ? 'true' : 'false');
  }
  function openBackdrop(){
    const b = $('#backdrop'); b.classList.add('active'); b.style.display='flex'; b.setAttribute('aria-hidden','false');
  }
  function closeBackdrop(){
    const b = $('#backdrop'); b.classList.remove('active'); b.style.display='none'; b.setAttribute('aria-hidden','true');
  }
  function clearForm(){
    $('#rowId').value=''; $('#f_adhar').value=''; $('#f_name').value='';
    $('#f_father').value=''; $('#f_account').value=''; $('#f_amount').value='';
    $('#f_dmr').value=''; $('#f_year').value=''; $('#f_done').value='false';
  }
  function validateForm(){
    const adhar = $('#f_adhar').value.trim();
    const name  = $('#f_name').value.trim();
    const amount= $('#f_amount').value.trim();
    const year  = $('#f_year').value.trim();
    if(adhar.length!==12 || !/^\d{12}$/.test(adhar)) { alert('‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞ 12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§ö‡§æ‡§π‡§ø‡§è'); return false; }
    if(!name){ alert('‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à'); return false; }
    if(amount && isNaN(Number(amount))){ alert('‡§∞‡§æ‡§∂‡§ø ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§π‡•ã'); return false; }
    if(year && (+year<1900 || +year>2100)){ alert('‡§µ‡§∞‡•ç‡§∑ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç'); return false; }
    return true;
  }

  // ------- AUTH -------
  sb.auth.onAuthStateChange(async (_e, session) => {
    currentUser = session?.user ?? null;
    setAuthUI();
    await loadData();
  });

  async function authLogin(){
    if(busy) return; busy = true;
    const btn = $('#loginBtn'); const old = btn.textContent;
    btn.disabled = true; btn.textContent = '‡§≤‡•â‡§ó-‡§á‡§®...';
    try{
      const email = $('#email').value.trim();
      const password = $('#password').value;
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if(error) throw error;
      currentUser = data.user;
      $('#loginBox').style.display='none';
      setAuthUI(); await loadData();
    }catch(e){ alert('Login failed: '+(e.message||'unknown')); }
    finally{ btn.disabled=false; btn.textContent=old; busy=false; }
  }

  async function authLogout(){
    if(busy) return; busy = true;
    try{
      let { error } = await sb.auth.signOut({ scope:'global' });
      if(error) await sb.auth.signOut({ scope:'local' });
      try{
        const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i)||''; if(k.startsWith('sb-')||k.includes('recovrybakimember-auth-v1')) keys.push(k); }
        keys.forEach(k=>localStorage.removeItem(k));
      }catch(_){}
      currentUser = null; setAuthUI(); $('#loginBox').style.display='none';
      await loadData();
      // ‡§Ö‡§ó‡§∞ ‡§ï‡§≠‡•Ä stale UI ‡§¶‡§ø‡§ñ‡•á ‡§§‡•ã ‡§®‡•Ä‡§ö‡•á line ‡§Ö‡§®-‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§ï‡§∞‡•á‡§Ç:
      // location.reload();
    }catch(e){ alert('Logout error: '+(e.message||'unknown')); }
    finally{ busy = false; }
  }

  // ------- DATA -------
  async function loadData(){
    const { data, error } = await sb.from('recovrybakimember').select('*').order('id',{ascending:true});
    if(error){ alert('Data load error: '+error.message); return; }
    const tbody = $('#dataTable tbody'); tbody.innerHTML='';
    (data||[]).forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.sn ?? ''}</td>
        <td>${r.adhar_number ?? ''}</td>
        <td>${r.name ?? ''}</td>
        <td>${r.father_name ?? ''}</td>
        <td>${r.account_number ?? ''}</td>
        <td>${r.amount ?? ''}</td>
        <td>${r.intrestdmr_number ?? ''}</td>
        <td>${r.year ?? ''}</td>
        <td>${r.recovery_done ? '<span class="badge done">‚úîÔ∏è Done</span>' : '<span class="badge pending">‚è≥ Pending</span>'}</td>
        <td>${
          currentUser
           ? `<button class="action edit-btn" data-id="${r.id}">Edit</button>
              <button class="action delete-btn" data-id="${r.id}">Delete</button>
              <button class="action done-btn" data-id="${r.id}">Done</button>`
           : '<span class="locked">üîí</span>'
        }</td>`;
      tbody.appendChild(tr);
    });
  }

  // ------- CRUD -------
  async function openEdit(id){
    if(!currentUser) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    editMode='edit'; $('#modalTitle').textContent = '‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü'; clearForm();
    const { data, error } = await sb.from('recovrybakimember').select('*').eq('id', id).single();
    if(error){ alert('Row fetch error: '+error.message); return; }
    $('#rowId').value = data.id;
    $('#f_adhar').value = data.adhar_number ?? '';
    $('#f_name').value = data.name ?? '';
    $('#f_father').value = data.father_name ?? '';
    $('#f_account').value = data.account_number ?? '';
    $('#f_amount').value = data.amount ?? '';
    $('#f_dmr').value = data.intrestdmr_number ?? '';
    $('#f_year').value = data.year ?? '';
    $('#f_done').value = data.recovery_done ? 'true' : 'false';
    openBackdrop();
  }
  function openCreate(){
    if(!currentUser) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    editMode='create'; $('#modalTitle').textContent = '‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ú‡•ã‡§°‡§º‡•á‡§Ç'; clearForm(); openBackdrop();
  }

  async function saveRecord(){
    if(!currentUser) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    if(busy) return; if(!validateForm()) return;
    busy = true;
    const btn = $('#saveBtn'); const old = btn.textContent; btn.disabled = true; btn.textContent = '‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
    const payload = {
      adhar_number: $('#f_adhar').value.trim(),
      name: $('#f_name').value.trim(),
      father_name: $('#f_father').value.trim() || null,
      account_number: $('#f_account').value.trim() || null,
      amount: $('#f_amount').value ? Number($('#f_amount').value) : null,
      intrestdmr_number: $('#f_dmr').value.trim() || null,
      year: $('#f_year').value ? Number($('#f_year').value) : null,
      recovery_done: $('#f_done').value === 'true'
    };
    try{
      if(editMode==='create'){
        const { error } = await sb.from('recovrybakimember').insert(payload);
        if(error) throw error;
      }else{
        const id = $('#rowId').value;
        const { error } = await sb.from('recovrybakimember').update(payload).eq('id', id);
        if(error) throw error;
      }
      closeBackdrop(); await loadData();
    }catch(e){ alert('Save error: ' + (e.message||'unknown')); }
    finally{ btn.disabled=false; btn.textContent=old; busy=false; }
  }

  async function deleteRow(id){
    if(!currentUser) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    if(busy) return; if(!confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) return;
    busy=true;
    try{ const { error } = await sb.from('recovrybakimember').delete().eq('id', id); if(error) throw error; await loadData(); }
    catch(e){ alert('Delete error: '+(e.message||'unknown')); }
    finally{ busy=false; }
  }

  async function markDone(id){
    if(!currentUser) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    if(busy) return; busy=true;
    try{ const { error } = await sb.from('recovrybakimember').update({ recovery_done:true }).eq('id', id); if(error) throw error; await loadData(); }
    catch(e){ alert('Mark done error: '+(e.message||'unknown')); }
    finally{ busy=false; }
  }

  // ------- BINDINGS (no inline onclick) -------
  document.addEventListener('DOMContentLoaded', ()=>{
    // login UI
    $('#loginToggleBtn').addEventListener('click', toggleLogin);
    $('#loginForm').addEventListener('submit', (e)=>{ e.preventDefault(); authLogin(); });
    $('#logoutBtn').addEventListener('click', authLogout);
    $('#topLogoutBtn').addEventListener('click', authLogout);

    // toolbar
    $('#refreshBtn').addEventListener('click', loadData);
    $('#addBtn').addEventListener('click', openCreate);

    // modal
    $('#cancelBtn').addEventListener('click', closeBackdrop);
    $('#saveBtn').addEventListener('click', saveRecord);

    // table actions (event delegation)
    $('#dataTable').addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.getAttribute('data-id');
      if(btn.classList.contains('edit-btn')) return openEdit(id);
      if(btn.classList.contains('delete-btn')) return deleteRow(id);
      if(btn.classList.contains('done-btn')) return markDone(id);
    });
  });

  // initial
  (async()=>{
    const { data:{ session } } = await sb.auth.getSession();
    currentUser = session?.user ?? null;
    setAuthUI();
    await loadData();
  })();
</script>
</body>
</html>
