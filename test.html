<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:'Inter','Noto Sans Devanagari',sans-serif;background:#f8fafc;margin:0}
    header{background:#4f46e5;color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
    header h2{margin:0;font-size:22px}
    .right{display:flex;gap:10px;align-items:center}
    #authStatus{font-size:18px}
    #loginIcon{background:#fff;color:#4f46e5;width:36px;height:36px;display:grid;place-items:center;border-radius:50%;cursor:pointer;font-size:18px;font-weight:700;box-shadow:0 2px 5px rgba(0,0,0,.2)}
    #loginBox{display:none;width:300px;margin:16px auto;background:#fff;border-radius:10px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.08);animation:slide .25s ease}
    #loginBox input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin:6px 0}
    #loginBox button{width:100%;padding:10px;border:none;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer}
    #loginBox small{color:#6b7280}
    @keyframes slide{from{transform:translateY(-8px);opacity:.0}to{transform:translateY(0);opacity:1}}

    .toolbar{width:95%;margin:12px auto 0;display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;color:#fff}
    .btn-add{background:#22c55e}
    .btn-refresh{background:#0ea5e9}
    .btn-logout{background:#ef4444}

    table{width:95%;margin:12px auto 18px;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    th,td{padding:10px 8px;border-bottom:1px solid #eef2ff;text-align:center}
    th{background:#eef2ff}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;display:inline-block}
    .pending{background:#fff7ed;color:#9a3412}
    .done{background:#ecfdf5;color:#065f46}
    button.action{padding:6px 10px;border:none;border-radius:8px;margin:2px;cursor:pointer;color:#fff}
    .edit-btn{background:#3b82f6}
    .delete-btn{background:#ef4444}
    .done-btn{background:#f59e0b}
    .locked{color:#9ca3af}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:92%;max-width:560px;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15);overflow:hidden}
    .modal header{background:#f1f5f9;color:#0f172a;padding:12px 16px}
    .modal .content{padding:14px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row .col{display:flex;flex-direction:column}
    .row input,.row select{padding:10px;border:1px solid #e5e7eb;border-radius:8px}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid #e5e7eb}
    .btn-secondary{background:#6b7280}
  </style>
</head>
<body>
  <header>
    <h2>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</h2>
    <div class="right">
      <span id="authStatus" title="Auth Status">üîí</span>
      <span id="loginIcon" title="Login" onclick="toggleLogin()">üîë</span>
    </div>
  </header>

  <!-- Login -->
  <div id="loginBox">
    <h3 style="margin:6px 0 8px">‡§≤‡•â‡§ó-‡§á‡§®</h3>
    <input type="email" id="email" placeholder="‡§à‡§Æ‡•á‡§≤" />
    <input type="password" id="password" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°" />
    <button onclick="login()">‡§≤‡•â‡§ó-‡§á‡§®</button>
    <small>‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‚Äî ‡§ï‡•á‡§µ‡§≤ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§≤‡•â‡§ó-‡§á‡§® ‡§ï‡§∞‡•á‡§Ç‡•§</small>
    <div style="margin-top:8px;text-align:center">
      <a href="javascript:void(0)" onclick="logout()" style="color:#4f46e5;text-decoration:none">‡§≤‡•â‡§ó-‡§Ü‡§â‡§ü</a>
    </div>
  </div>

  <!-- Toolbar (login ‡§™‡§∞ ‡§π‡•Ä Add ‡§¶‡§ø‡§ñ‡•á) -->
  <div class="toolbar">
    <button class="btn btn-refresh" onclick="loadData()">Refresh</button>
    <button id="addBtn" class="btn btn-add" style="display:none" onclick="openEditModal('create')">+ ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</button>
    <button id="logoutBtn" class="btn btn-logout" style="display:none" onclick="logout()">Logout</button>
  </div>

  <!-- Data Table -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>S.N.</th>
        <th>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞</th>
        <th>‡§®‡§æ‡§Æ</th>
        <th>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
        <th>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞</th>
        <th>‡§∞‡§æ‡§∂‡§ø</th>
        <th>DMR ‡§®‡§Ç‡§¨‡§∞</th>
        <th>‡§µ‡§∞‡•ç‡§∑</th>
        <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
        <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Edit/Create Modal -->
  <div id="backdrop" class="modal-backdrop">
    <div class="modal">
      <header><strong id="modalTitle">‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü</strong></header>
      <div class="content">
        <input type="hidden" id="rowId" />
        <div class="row">
          <div class="col">
            <label>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞ (12 ‡§Ö‡§Ç‡§ï)</label>
            <input id="f_adhar" maxlength="12" placeholder="123456789012" />
          </div>
          <div class="col">
            <label>‡§®‡§æ‡§Æ</label>
            <input id="f_name" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
            <input id="f_father" />
          </div>
          <div class="col">
            <label>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞</label>
            <input id="f_account" maxlength="20" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>‡§∞‡§æ‡§∂‡§ø</label>
            <input id="f_amount" type="number" step="0.01" />
          </div>
          <div class="col">
            <label>DMR ‡§®‡§Ç‡§¨‡§∞</label>
            <input id="f_dmr" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="col">
            <label>‡§µ‡§∞‡•ç‡§∑</label>
            <input id="f_year" type="number" placeholder="2025" />
          </div>
          <div class="col">
            <label>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
            <select id="f_done">
              <option value="false">Pending</option>
              <option value="true">Done</option>
            </select>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">‡§∞‡§¶‡•ç‡§¶</button>
        <button class="btn btn-add" onclick="saveRecord()">‡§∏‡•á‡§µ</button>
      </div>
    </div>
  </div>

<script>
  // ‚õ≥ ‡§Ö‡§™‡§®‡•Ä keys ‡§≠‡§∞‡•á‡§Ç
  const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";

  // ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ stable auth options
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true, // ‡§∏‡§æ‡§µ‡§ß‡§æ‡§®‡•Ä: OAuth ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§´‡§ø‡§∞ ‡§≠‡•Ä safe
      storageKey: "recovrybakimember-auth-v1"
    }
  });

  let user = null;
  let mode = 'edit'; // 'create' | 'edit'

  // ---------- UI helpers ----------
  function setAuthUI(){
    const isLogged = !!user;
    document.getElementById('authStatus').textContent = isLogged ? '‚úÖ' : 'üîí';
    const addBtn = document.getElementById('addBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    if (addBtn) addBtn.style.display = isLogged ? 'inline-block' : 'none';
    if (logoutBtn) logoutBtn.style.display = isLogged ? 'inline-block' : 'none';

    // header ‡§Æ‡•á‡§Ç email ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
    const emailBadgeId = 'emailBadge';
    let badge = document.getElementById(emailBadgeId);
    if (!badge) {
      badge = document.createElement('span');
      badge.id = emailBadgeId;
      badge.style.cssText = 'color:#fff;background:#16a34a;padding:4px 8px;border-radius:999px;margin-left:8px;font-size:12px;display:none';
      document.querySelector('.right').prepend(badge);
    }
    if (isLogged) {
      badge.textContent = user.email || 'logged-in';
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  }

  function toggleLogin(){
    const el = document.getElementById('loginBox');
    el.style.display = (el.style.display === 'block') ? 'none' : 'block';
  }

  function showError(prefix, error){
    console.error(prefix, error);
    const msg = (error && (error.message || error.error_description || error.hint)) ? `\n${error.message || error.error_description || error.hint}` : '';
    alert(prefix + msg);
  }

  // ---------- Auth ----------
  sb.auth.onAuthStateChange(async (_event, session) => {
    user = session?.user ?? null;
    setAuthUI();
    await loadData();  // login/logout ‡§™‡§∞ table refresh
  });

  async function login(){
    try {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const { data, error } = await sb.auth.signInWithPassword({ email, password });
      if (error) return showError('Login failed:', error);
      user = data.user;
      document.getElementById('loginBox').style.display = 'none';
      setAuthUI();
      await loadData();
    } catch (e) {
      showError('Login exception:', e);
    }
  }

  async function logout(){
    try {
      const { error } = await sb.auth.signOut();
      if (error) return showError('Logout failed:', error);
      user = null;
      setAuthUI();
      document.getElementById('loginBox').style.display = 'none';
      await loadData();
      alert('Logged out');
    } catch (e) {
      showError('Logout exception:', e);
    }
  }

  // ---------- Data ----------
  async function loadData(){
    try {
      const { data, error } = await sb
        .from('recovrybakimember')
        .select('*')
        .order('id', { ascending: true });

      if (error) return showError('Data load error:', error);

      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      (data || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.sn ?? ''}</td>
          <td>${r.adhar_number ?? ''}</td>
          <td>${r.name ?? ''}</td>
          <td>${r.father_name ?? ''}</td>
          <td>${r.account_number ?? ''}</td>
          <td>${r.amount ?? ''}</td>
          <td>${r.intrestdmr_number ?? ''}</td>
          <td>${r.year ?? ''}</td>
          <td>${r.recovery_done ? '<span class="badge done">‚úîÔ∏è Done</span>' : '<span class="badge pending">‚è≥ Pending</span>'}</td>
          <td>
            ${
              user
              ? `
                <button class="action edit-btn" onclick="openEditModal('edit', ${r.id})">Edit</button>
                <button class="action delete-btn" onclick="deleteRow(${r.id})">Delete</button>
                <button class="action done-btn" onclick="markDone(${r.id})">Done</button>
              `
              : '<span class="locked" title="Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï">üîí</span>'
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      showError('Load exception:', e);
    }
  }

  // ---------- Modal Create/Edit ----------
  let mode = 'edit';
  async function openEditModal(m, id=null){
    if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    mode = m;
    document.getElementById('modalTitle').textContent = (mode==='create') ? '‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ú‡•ã‡§°‡§º‡•á‡§Ç' : '‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü';
    clearForm();

    if(mode==='edit' && id){
      const { data, error } = await sb.from('recovrybakimember').select('*').eq('id', id).single();
      if(error) return showError('Fetch row failed:', error);
      document.getElementById('rowId').value = data.id;
      document.getElementById('f_adhar').value = data.adhar_number ?? '';
      document.getElementById('f_name').value = data.name ?? '';
      document.getElementById('f_father').value = data.father_name ?? '';
      document.getElementById('f_account').value = data.account_number ?? '';
      document.getElementById('f_amount').value = data.amount ?? '';
      document.getElementById('f_dmr').value = data.intrestdmr_number ?? '';
      document.getElementById('f_year').value = data.year ?? '';
      document.getElementById('f_done').value = data.recovery_done ? 'true' : 'false';
    }

    document.getElementById('backdrop').style.display = 'flex';
  }

  function closeEditModal(){ document.getElementById('backdrop').style.display = 'none'; }

  function clearForm(){
    document.getElementById('rowId').value = '';
    document.getElementById('f_adhar').value = '';
    document.getElementById('f_name').value = '';
    document.getElementById('f_father').value = '';
    document.getElementById('f_account').value = '';
    document.getElementById('f_amount').value = '';
    document.getElementById('f_dmr').value = '';
    document.getElementById('f_year').value = '';
    document.getElementById('f_done').value = 'false';
  }

  function validateForm(){
    const adhar = document.getElementById('f_adhar').value.trim();
    const name = document.getElementById('f_name').value.trim();
    const amount = document.getElementById('f_amount').value.trim();
    const year = document.getElementById('f_year').value.trim();

    if(adhar.length !== 12 || !/^\d{12}$/.test(adhar)) { alert('‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞ 12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§ö‡§æ‡§π‡§ø‡§è'); return false; }
    if(!name){ alert('‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à'); return false; }
    if(amount && isNaN(Number(amount))){ alert('‡§∞‡§æ‡§∂‡§ø ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§π‡•ã'); return false; }
    if(year && (Number(year) < 1900 || Number(year) > 2100)){ alert('‡§µ‡§∞‡•ç‡§∑ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç'); return false; }
    return true;
  }

  async function saveRecord(){
    if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    if(!validateForm()) return;

    const payload = {
      adhar_number: document.getElementById('f_adhar').value.trim(),
      name: document.getElementById('f_name').value.trim(),
      father_name: document.getElementById('f_father').value.trim() || null,
      account_number: document.getElementById('f_account').value.trim() || null,
      amount: document.getElementById('f_amount').value ? Number(document.getElementById('f_amount').value) : null,
      intrestdmr_number: document.getElementById('f_dmr').value.trim() || null,
      year: document.getElementById('f_year').value ? Number(document.getElementById('f_year').value) : null,
      recovery_done: document.getElementById('f_done').value === 'true'
    };

    try {
      if(mode === 'create'){
        const { error } = await sb.from('recovrybakimember').insert(payload);
        if(error) return showError('Insert failed:', error);
        alert('‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ');
      } else {
        const id = document.getElementById('rowId').value;
        const { error } = await sb.from('recovrybakimember').update(payload).eq('id', id);
        if(error) return showError('Update failed:', error);
        alert('‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•Å‡§Ü');
      }
      closeEditModal();
      loadData();
    } catch (e) {
      showError('Save exception:', e);
    }
  }

  async function deleteRow(id){
    if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    if(!confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) return;
    const { error } = await sb.from('recovrybakimember').delete().eq('id', id);
    if(error) return showError('Delete failed:', error);
    loadData();
  }

  async function markDone(id){
    if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    const { error } = await sb.from('recovrybakimember').update({ recovery_done: true }).eq('id', id);
    if(error) return showError('Mark done failed:', error);
    loadData();
  }

  // First paint
  (async () => {
    const { data: { session } } = await sb.auth.getSession();
    user = session?.user ?? null;
    setAuthUI();
    await loadData();
  })();
</script>

</body>
</html>
