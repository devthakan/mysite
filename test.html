<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+Devanagari:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  :root{--bg:#0b1020;--card:#11172b;--muted:#8fa0c6;--pri:#6c8cff;--pri2:#94a9ff;--ok:#22c55e;--warn:#f59e0b;--danger:#ef4444;--border:#1f2a44}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430 60%,#0b1020);color:#eaf0ff;font-family:'Inter','Noto Sans Devanagari',system-ui}

  /* Header */
  header{position:sticky;top:0;z-index:1000;background:rgba(11,16,32,.75);backdrop-filter:blur(8px);
         border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
  .title{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--pri);box-shadow:0 0 12px var(--pri2)}
  .right{display:flex;gap:8px;align-items:center}
  #authIcon{font-size:18px}
  #authBadge{display:none;font-size:12px;padding:4px 10px;border-radius:999px;background:rgba(148,169,255,.15);color:var(--pri2);border:1px solid rgba(148,169,255,.35)}

  /* üîë Floating login toggle to avoid any overlay issues */
  #loginToggle{
    position:fixed; top:12px; right:12px; z-index:9999;
    border:1px solid rgba(148,169,255,.35);
    background:linear-gradient(180deg,rgba(148,169,255,.25),rgba(148,169,255,.1));
    color:var(--pri2); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700;
  }

  .wrap{max-width:1200px;margin:16px auto;padding:0 12px}

  /* Login panel */
  #loginBox{display:none;width:min(380px,92%);margin:10px 0 0 auto;background:linear-gradient(180deg,#0f1833,#0d152e);
            border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,.35),inset 0 0 0 1px rgba(108,140,255,.06)}
  #loginBox h3{margin:4px 0 10px}
  #loginBox input{width:100%;padding:12px;margin:6px 0 10px;border-radius:10px;border:1px solid var(--border);background:#0b1328;color:#eaf0ff}
  #loginBox button{width:100%;padding:12px;border:none;border-radius:10px;cursor:pointer;color:#fff;font-weight:600}
  #loginBtn{background:linear-gradient(180deg,var(--pri),#5576ff)}
  #logoutBtn{display:none;margin-top:8px;background:linear-gradient(180deg,#ef4444,#dc2626)}

  /* Toolbar */
  .toolbar{display:flex;gap:10px;justify-content:flex-end;align-items:center;margin:14px 0}
  .btn{padding:10px 12px;border:none;border-radius:10px;cursor:pointer;color:#fff;font-weight:600;border:1px solid rgba(255,255,255,.08)}
  .btn-refresh{background:linear-gradient(180deg,#3db2ff,#2b93e6)}
  .btn-add{background:linear-gradient(180deg,#22c55e,#16a34a);display:none}
  .btn-logout{background:linear-gradient(180deg,#ef4444,#dc2626);display:none}

  /* Card + Table */
  .card{background:linear-gradient(180deg,#0f1833,#0d152e);border:1px solid var(--border);border-radius:16px;overflow:hidden;
        box-shadow:0 20px 60px rgba(0,0,0,.45),inset 0 0 0 1px rgba(108,140,255,.06)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:center}
  th{background:linear-gradient(180deg,rgba(148,169,255,.12),rgba(148,169,255,.06));color:#dbe4ff;font-weight:700}
  td{color:#eaf0ff}
  .badge{padding:4px 10px;border-radius:999px;font-size:12px;display:inline-block}
  .done{background:rgba(34,197,94,.12);color:#34d399;border:1px solid rgba(34,197,94,.35)}
  .pending{background:rgba(245,158,11,.12);color:#fbbf24;border:1px solid rgba(245,158,11,.35)}
  .action{padding:7px 10px;border:none;border-radius:10px;margin:2px;cursor:pointer;color:#fff;font-weight:600;border:1px solid rgba(255,255,255,.08)}
  .edit{background:linear-gradient(180deg,#3b82f6,#2563eb)} .del{background:linear-gradient(180deg,#ef4444,#dc2626)} .mark{background:linear-gradient(180deg,#f59e0b,#d97706)}
  .locked{color:var(--muted)}

  /* Modal ‚Äî simple, non-blocking, sticky footer so Save always visible */
  #modal{display:none;position:fixed;inset:0;background:rgba(5,9,20,.6);z-index:2000;align-items:center;justify-content:center}
  .dialog{width:min(780px,94%);max-height:90vh;background:linear-gradient(180deg,#101a37,#0f1833);border:1px solid var(--border);
          border-radius:16px;display:flex;flex-direction:column;box-shadow:0 25px 80px rgba(0,0,0,.55)}
  .dialog header{padding:12px 16px;border-bottom:1px solid var(--border);font-weight:700}
  .dialog .content{padding:14px;overflow:auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .col{display:flex;flex-direction:column}
  .col label{color:#cbd5ff;margin-bottom:6px;font-size:13px}
  .col input,.col select{padding:11px;border-radius:10px;border:1px solid var(--border);background:#0b1328;color:#eaf0ff}
  .dialog .actions{position:sticky;bottom:0;display:flex;gap:10px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border);
                   background:linear-gradient(180deg,rgba(148,169,255,.08),rgba(148,169,255,.04))}
  .btn-secondary{background:linear-gradient(180deg,#6b7280,#4b5563)}
  @media (max-width:760px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <header>
    <div class="title"><div class="dot"></div><h3 style="margin:0">‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</h3></div>
    <div class="right">
      <span id="authIcon">üîí</span>
      <span id="authBadge"></span>
    </div>
  </header>
  <!-- üîë Floating toggle (always clickable) -->
  <button id="loginToggle" type="button" title="Login">üîë</button>

  <div class="wrap">
    <!-- Login -->
    <div id="loginBox">
      <h3>‡§≤‡•â‡§ó-‡§á‡§®</h3>
      <form id="loginForm">
        <input id="email" type="email" placeholder="Email" required>
        <input id="password" type="password" placeholder="Password" required>
        <button id="loginBtn" type="submit">Login</button>
      </form>
      <button id="logoutBtn">Logout</button>
      <small style="color:#8fa0c6">Signup ‡§¨‡§Ç‡§¶ ‡§π‡•à ‚Äî ‡§ï‡•á‡§µ‡§≤ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ users login ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§</small>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <button id="refreshBtn" class="btn btn-refresh" type="button">Refresh</button>
      <button id="addBtn" class="btn btn-add" type="button">+ ‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</button>
      <button id="topLogoutBtn" class="btn btn-logout" type="button">Logout</button>
    </div>

    <!-- Table -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>S.N.</th><th>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞</th><th>‡§®‡§æ‡§Æ</th><th>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
            <th>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞</th><th>‡§∞‡§æ‡§∂‡§ø</th><th>DMR ‡§®‡§Ç‡§¨‡§∞</th><th>‡§µ‡§∞‡•ç‡§∑</th>
            <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th><th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" aria-hidden="true">
    <div class="dialog">
      <header id="modalTitle">‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°</header>
      <div class="content">
        <input type="hidden" id="rowId" />
        <div class="grid">
          <div class="col"><label>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞ (12)</label><input id="f_adhar" maxlength="12"></div>
          <div class="col"><label>‡§®‡§æ‡§Æ</label><input id="f_name"></div>
          <div class="col"><label>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</label><input id="f_father"></div>
          <div class="col"><label>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞</label><input id="f_account" maxlength="20"></div>
          <div class="col"><label>‡§∞‡§æ‡§∂‡§ø</label><input id="f_amount" type="number" step="0.01"></div>
          <div class="col"><label>DMR ‡§®‡§Ç‡§¨‡§∞</label><input id="f_dmr"></div>
          <div class="col"><label>‡§µ‡§∞‡•ç‡§∑</label><input id="f_year" type="number" placeholder="2025"></div>
          <div class="col"><label>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
            <select id="f_done"><option value="false">Pending</option><option value="true">Done</option></select>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="cancelBtn" class="btn btn-secondary" type="button">‡§∞‡§¶‡•ç‡§¶</button>
        <button id="saveBtn" class="btn btn-add" type="button" style="display:inline-block">üíæ ‡§∏‡•á‡§µ</button>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG: ‡§Ö‡§™‡§®‡•Ä keys ‡§≠‡§∞‡•ã (https origin ‡§™‡§∞ ‡§ö‡§≤‡§æ‡§è‡§Å) ===== */
const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";
if(!/^https?:\/\//.test(location.href)) alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§á‡§∏ ‡§™‡•á‡§ú ‡§ï‡•ã https origin ‡§∏‡•á ‡§ñ‡•ã‡§≤‡•á‡§Ç (file:// ‡§®‡§π‡•Ä‡§Ç)");
if(!SUPABASE_URL || !SUPABASE_ANON_KEY) alert("SUPABASE_URL/ANON KEY ‡§≠‡§∞‡•á‡§Ç");
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey:"recovrybakimember-auth-v1" }
});

/* ===== STATE ===== */
let user=null, busy=false, mode='create';

/* ===== HELPERS ===== */
const $=s=>document.querySelector(s);
function setAuthUI(){
  const logged=!!user;
  $('#authIcon').textContent = logged ? '‚úÖ' : 'üîí';
  $('#authBadge').style.display = (logged && user.email) ? 'inline-block' : 'none';
  if(logged && user.email) $('#authBadge').textContent = user.email;
  $('#addBtn').style.display = logged ? 'inline-block' : 'none';
  $('#topLogoutBtn').style.display = logged ? 'inline-block' : 'none';
  $('#logoutBtn').style.display = logged ? 'block' : 'none';
}
function toggleLogin(){
  const b=$('#loginBox'); b.style.display = (b.style.display==='block') ? 'none' : 'block';
}
function openModal(){ $('#modal').style.display='flex'; $('#modal').setAttribute('aria-hidden','false'); }
function closeModal(){ $('#modal').style.display='none'; $('#modal').setAttribute('aria-hidden','true'); }
function clearForm(){
  $('#rowId').value=''; $('#f_adhar').value=''; $('#f_name').value='';
  $('#f_father').value=''; $('#f_account').value=''; $('#f_amount').value='';
  $('#f_dmr').value=''; $('#f_year').value=''; $('#f_done').value='false';
}
function validateForm(){
  const a=$('#f_adhar').value.trim(), n=$('#f_name').value.trim(), amt=$('#f_amount').value.trim(), y=$('#f_year').value.trim();
  if(a.length!==12 || !/^\d{12}$/.test(a)) return alert('‡§Ü‡§ß‡§æ‡§∞ 12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§ö‡§æ‡§π‡§ø‡§è'), false;
  if(!n) return alert('‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§π‡•à'), false;
  if(amt && isNaN(Number(amt))) return alert('‡§∞‡§æ‡§∂‡§ø ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§π‡•ã'), false;
  if(y && (+y<1900 || +y>2100)) return alert('‡§µ‡§∞‡•ç‡§∑ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç'), false;
  return true;
}

/* ===== AUTH ===== */
sb.auth.onAuthStateChange(async (_e, session)=>{ user=session?.user??null; setAuthUI(); await loadData(); });
async function doLogin(){
  if(busy) return; busy=true;
  const btn=$('#loginBtn'); const old=btn.textContent; btn.disabled=true; btn.textContent='‡§≤‡•â‡§ó-‡§á‡§®...';
  try{
    const email=$('#email').value.trim(), password=$('#password').value;
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) throw error;
    user=data.user; $('#loginBox').style.display='none'; setAuthUI(); await loadData();
  }catch(e){ alert('Login failed: '+(e.message||'unknown')); }
  finally{ btn.disabled=false; btn.textContent=old; busy=false; }
}
async function doLogout(){
  if(busy) return; busy=true;
  try{
    let { error } = await sb.auth.signOut({ scope:'global' });
    if(error) await sb.auth.signOut({ scope:'local' });
    try{
      const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i)||''; if(k.startsWith('sb-')||k.includes('recovrybakimember-auth-v1')) keys.push(k); }
      keys.forEach(k=>localStorage.removeItem(k));
    }catch(_){}
    user=null; setAuthUI(); $('#loginBox').style.display='none'; await loadData();
    location.reload(); // stale UI ‡§ñ‡§§‡•ç‡§Æ
  }catch(e){ alert('Logout error: '+(e.message||'unknown')); }
  finally{ busy=false; }
}

/* ===== DATA ===== */
async function loadData(){
  const { data, error } = await sb.from('recovrybakimember').select('*').order('id',{ascending:true});
  if(error) return alert('Data load error: '+error.message);
  const tb=$('#tbody'); tb.innerHTML='';
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.sn??''}</td><td>${r.adhar_number??''}</td><td>${r.name??''}</td>
      <td>${r.father_name??''}</td><td>${r.account_number??''}</td>
      <td>${r.amount??''}</td><td>${r.intrestdmr_number??''}</td>
      <td>${r.year??''}</td>
      <td>${r.recovery_done?'<span class="badge done">‚úîÔ∏è Done</span>':'<span class="badge pending">‚è≥ Pending</span>'}</td>
      <td>${
        user
        ? `<button class="action edit" data-id="${r.id}">Edit</button>
           <button class="action del" data-id="${r.id}">Delete</button>
           <button class="action mark" data-id="${r.id}">Done</button>`
        : '<span class="locked">üîí</span>'
      }</td>`;
    tb.appendChild(tr);
  });
}

/* ===== CRUD ===== */
async function openCreate(){ if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï'); mode='create'; $('#modalTitle').textContent='‡§®‡§Ø‡§æ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°'; clearForm(); openModal(); }
async function openEdit(id){
  if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï'); mode='edit'; $('#modalTitle').textContent='‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§Ö‡§™‡§°‡•á‡§ü'; clearForm();
  const { data, error } = await sb.from('recovrybakimember').select('*').eq('id',id).single();
  if(error) return alert('Row fetch error: '+error.message);
  $('#rowId').value=data.id; $('#f_adhar').value=data.adhar_number||''; $('#f_name').value=data.name||'';
  $('#f_father').value=data.father_name||''; $('#f_account').value=data.account_number||'';
  $('#f_amount').value=data.amount||''; $('#f_dmr').value=data.intrestdmr_number||'';
  $('#f_year').value=data.year||''; $('#f_done').value=data.recovery_done?'true':'false';
  openModal();
}
async function saveRecord(){
  if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï'); if(busy) return; if(!validateForm()) return; busy=true;
  const btn=$('#saveBtn'); const old=btn.textContent; btn.disabled=true; btn.textContent='‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
  const payload={
    adhar_number: $('#f_adhar').value.trim(),
    name: $('#f_name').value.trim(),
    father_name: $('#f_father').value.trim()||null,
    account_number: $('#f_account').value.trim()||null,
    amount: $('#f_amount').value?Number($('#f_amount').value):null,
    intrestdmr_number: $('#f_dmr').value.trim()||null,
    year: $('#f_year').value?Number($('#f_year').value):null,
    recovery_done: $('#f_done').value==='true'
  };
  try{
    if(mode==='create'){
      const { error } = await sb.from('recovrybakimember').insert(payload); if(error) throw error;
    }else{
      const id=$('#rowId').value; const { error } = await sb.from('recovrybakimember').update(payload).eq('id',id); if(error) throw error;
    }
    closeModal(); await loadData();
  }catch(e){ alert('Save error: '+(e.message||'unknown')); }
  finally{ btn.disabled=false; btn.textContent=old; busy=false; }
}
async function deleteRow(id){
  if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
  if(!confirm('‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§π‡§ü‡§æ‡§è‡§Å?')) return;
  const { error } = await sb.from('recovrybakimember').delete().eq('id',id);
  if(error) return alert('Delete error: '+error.message);
  await loadData();
}
async function markDone(id){
  if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
  const { error } = await sb.from('recovrybakimember').update({recovery_done:true}).eq('id',id);
  if(error) return alert('Mark done error: '+error.message);
  await loadData();
}

/* ===== BINDINGS ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Floating toggle (always clickable)
  $('#loginToggle').addEventListener('click', toggleLogin);

  // Login form
  $('#loginForm').addEventListener('submit', e=>{ e.preventDefault(); doLogin(); });
  $('#logoutBtn').addEventListener('click', doLogout);
  $('#topLogoutBtn').addEventListener('click', doLogout);

  // Toolbar
  $('#refreshBtn').addEventListener('click', loadData);
  $('#addBtn').addEventListener('click', openCreate);

  // Modal
  $('#cancelBtn').addEventListener('click', closeModal);
  $('#saveBtn').addEventListener('click', saveRecord);

  // Table actions (delegation)
  $('#tbody').addEventListener('click', e=>{
    const b=e.target.closest('button'); if(!b) return;
    const id=b.getAttribute('data-id');
    if(b.classList.contains('edit')) return openEdit(id);
    if(b.classList.contains('del')) return deleteRow(id);
    if(b.classList.contains('mark')) return markDone(id);
  });
});

/* Initial load */
(async()=>{ const { data:{session} }=await sb.auth.getSession(); user=session?.user??null; setAuthUI(); await loadData(); })();
</script>
</body>
</html>
