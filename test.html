<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Inter','Noto Sans Devanagari',sans-serif; background:#f8fafc; margin:0 }
    header{ background:#4f46e5; color:#fff; padding:14px 18px; display:flex; align-items:center; justify-content:space-between }
    header h2{ margin:0; font-size:22px }
    .right{ display:flex; gap:10px; align-items:center }
    #authStatus{ font-size:18px }
    #loginIcon{
      background:#fff; color:#4f46e5; width:36px; height:36px; display:grid; place-items:center;
      border-radius:50%; cursor:pointer; font-size:18px; font-weight:700; box-shadow:0 2px 5px rgba(0,0,0,.2)
    }
    #loginBox{
      display:none; width:300px; margin:16px auto; background:#fff; border-radius:10px; padding:14px;
      box-shadow:0 6px 20px rgba(0,0,0,.08); animation:slide .25s ease
    }
    #loginBox input{ width:100%; padding:10px; border:1px solid #e5e7eb; border-radius:8px; margin:6px 0 }
    #loginBox button{ width:100%; padding:10px; border:none; border-radius:8px; background:#4f46e5; color:#fff; cursor:pointer }
    #loginBox small{ color:#6b7280 }
    @keyframes slide{ from{ transform:translateY(-8px); opacity:.0 } to{ transform:translateY(0); opacity:1 } }

    table{ width:95%; margin:18px auto; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden;
           box-shadow:0 2px 10px rgba(0,0,0,.05) }
    th,td{ padding:10px 8px; border-bottom:1px solid #eef2ff; text-align:center }
    th{ background:#eef2ff }
    .badge{ padding:4px 8px; border-radius:999px; font-size:12px; display:inline-block }
    .pending{ background:#fff7ed; color:#9a3412 }
    .done{ background:#ecfdf5; color:#065f46 }

    button.action{ padding:6px 10px; border:none; border-radius:8px; margin:2px; cursor:pointer; color:#fff }
    .edit-btn{ background:#3b82f6 } .delete-btn{ background:#ef4444 } .done-btn{ background:#f59e0b }
    .locked{ color:#9ca3af }
  </style>
</head>
<body>
  <header>
    <h2>‡§∞‡§ø‡§ï‡§µ‡§∞‡•Ä ‡§¨‡§ï‡§æ‡§Ø‡§æ ‡§∏‡•Ç‡§ö‡•Ä</h2>
    <div class="right">
      <span id="authStatus" title="Auth Status">üîí</span>
      <span id="loginIcon" title="Login" onclick="toggleLogin()">üîë</span>
    </div>
  </header>

  <!-- Login (signup removed) -->
  <div id="loginBox">
    <h3 style="margin:6px 0 8px">‡§≤‡•â‡§ó-‡§á‡§®</h3>
    <input type="email" id="email" placeholder="‡§à‡§Æ‡•á‡§≤">
    <input type="password" id="password" placeholder="‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°">
    <button onclick="login()">‡§≤‡•â‡§ó-‡§á‡§®</button>
    <small>‡§®‡§Ø‡§æ ‡§Ö‡§ï‡§æ‡§â‡§Ç‡§ü ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•Ä ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à ‚Äî ‡§ï‡•á‡§µ‡§≤ ‡§Ö‡§ß‡§ø‡§ï‡•É‡§§ ‡§Ø‡•Ç‡§ú‡§º‡§∞‡•ç‡§∏ ‡§≤‡•â‡§ó-‡§á‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§</small>
    <div style="margin-top:8px; text-align:center">
      <a href="javascript:void(0)" onclick="logout()" style="color:#4f46e5; text-decoration:none">‡§≤‡•â‡§ó-‡§Ü‡§â‡§ü</a>
    </div>
  </div>

  <!-- Data Table -->
  <table id="dataTable">
    <thead>
      <tr>
        <th>S.N.</th>
        <th>‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞</th>
        <th>‡§®‡§æ‡§Æ</th>
        <th>‡§™‡§ø‡§§‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ</th>
        <th>‡§ñ‡§æ‡§§‡§æ ‡§®‡§Ç‡§¨‡§∞</th>
        <th>‡§∞‡§æ‡§∂‡§ø</th>
        <th>DMR ‡§®‡§Ç‡§¨‡§∞</th>
        <th>‡§µ‡§∞‡•ç‡§∑</th>
        <th>‡§∏‡•ç‡§•‡§ø‡§§‡§ø</th>
        <th>‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // ‚õ≥ ‡§Ø‡§π‡§æ‡§Ç ‡§Ö‡§™‡§®‡•Ä keys ‡§°‡§æ‡§≤‡•á‡§Ç
  const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let user = null;

  // Toggle login box
  function toggleLogin(){
    const el = document.getElementById('loginBox');
    el.style.display = (el.style.display === 'block') ? 'none' : 'block';
  }

  // Auth state listener (refresh UI on login/logout)
  sb.auth.onAuthStateChange(async (event, session) => {
    user = session?.user ?? null;
    document.getElementById('authStatus').textContent = user ? '‚úÖ' : 'üîí';
    await loadData();
  });

  async function login(){
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error){ alert(error.message); return; }
    document.getElementById('loginBox').style.display = 'none';
  }

  async function logout(){
    await sb.auth.signOut();
    document.getElementById('loginBox').style.display = 'none';
  }

  async function loadData(){
    const { data, error } = await sb.from('recovrybakimember')
      .select('*')
      .order('id', { ascending: true });

    if(error){ console.error(error); alert('Data load error'); return; }

    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.sn ?? ''}</td>
        <td>${r.adhar_number ?? ''}</td>
        <td>${r.name ?? ''}</td>
        <td>${r.father_name ?? ''}</td>
        <td>${r.account_number ?? ''}</td>
        <td>${r.amount ?? ''}</td>
        <td>${r.intrestdmr_number ?? ''}</td>
        <td>${r.year ?? ''}</td>
        <td>${r.recovery_done ? '<span class="badge done">‚úîÔ∏è Done</span>' : '<span class="badge pending">‚è≥ Pending</span>'}</td>
        <td>
          ${
            user
            ? `
              <button class="action edit-btn" onclick="editRow(${r.id})">Edit</button>
              <button class="action delete-btn" onclick="deleteRow(${r.id})">Delete</button>
              <button class="action done-btn" onclick="markDone(${r.id})">Done</button>
            `
            : '<span class="locked" title="Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï">üîí</span>'
          }
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function deleteRow(id){
    if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    if(!confirm('‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§á‡§∏ ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?')) return;
    const { error } = await sb.from('recovrybakimember').delete().eq('id', id);
    if(error){ alert(error.message); return; }
    loadData();
  }

  async function markDone(id){
    if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    const { error } = await sb.from('recovrybakimember').update({ recovery_done: true }).eq('id', id);
    if(error){ alert(error.message); return; }
    loadData();
  }

  function editRow(id){
    if(!user) return alert('Login ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï');
    alert('Edit form ‡§Ö‡§ó‡§≤‡•Ä ‡§∏‡•ç‡§ü‡•á‡§™ ‡§Æ‡•á‡§Ç add ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á‡•§');
  }

  // Load on first paint + restore session
  (async () => {
    const { data: { session } } = await sb.auth.getSession();
    user = session?.user ?? null;
    document.getElementById('authStatus').textContent = user ? '‚úÖ' : 'üîí';
    await loadData();
  })();
</script>
</body>
</html>
