<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>बकाया रिकवरी सूची</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        #app-container { max-width: 900px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #login-section, #recovery-section { width: 100%; }
        h2 { text-align: center; color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .update-form, #login-form { margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .hidden { display: none; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #logout-button { background-color: #dc3545; }
        #logout-button:hover { background-color: #c82333; }
        input[type="text"], input[type="email"], input[type="password"] { width: 100%; padding: 8px; margin: 5px 0 15px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #notification { padding: 15px; margin-bottom: 20px; border-radius: 5px; color: #fff; text-align: center; }
        .notification-success { background-color: #28a745; }
        .notification-error { background-color: #dc3545; }
        .notification-info { background-color: #17a2b8; }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="notification" class="hidden"></div>

        <div id="login-section">
            <h2>एडमिन लॉगिन</h2>
            <form id="login-form">
                <label for="email">ईमेल:</label>
                <input type="email" id="email" required placeholder="अपना ईमेल डालें">
                <label for="password">पासवर्ड:</label>
                <input type="password" id="password" required placeholder="अपना पासवर्ड डालें">
                <button type="submit" id="login-button">लॉगिन</button>
            </form>
        </div>

        <div id="recovery-section" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>बकाया किसानों की रिकवरी सूची</h2>
                <button id="logout-button">लॉगआउट</button>
            </div>
            <table id="recovery-table">
                <thead>
                    <tr>
                        <th>क्र.सं.</th>
                        <th>आधार</th>
                        <th>नाम</th>
                        <th>पिता का नाम</th>
                        <th>खाता संख्या</th>
                        <th>राशि</th>
                        <th>ब्याज</th>
                        <th>DMR</th>
                        <th>वर्ष</th>
                        <th>रिकवरी हुई?</th>
                        <th>कार्यवाही</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="update-form">
                <h3>रिकवरी स्टेटस अपडेट करें</h3>
                <form id="update-form">
                    <input type="hidden" id="update-sn">
                    <label for="recovery_done">रिकवरी हुई (हाँ/नहीं):</label>
                    <input type="text" id="recovery_done" required>
                    <button type="submit" id="update-button">अपडेट करें</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // HTML एलिमेंट्स
        const loginSection = document.getElementById('login-section');
        const recoverySection = document.getElementById('recovery-section');
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const recoveryTableBody = document.querySelector('#recovery-table tbody');
        const updateForm = document.getElementById('update-form');
        const updateButton = document.getElementById('update-button');
        const updateSn = document.getElementById('update-sn');
        const recoveryDoneInput = document.getElementById('recovery_done');
        const notification = document.getElementById('notification');

        // नोटिफिकेशन फंक्शन
        const showNotification = (message, type = 'info', duration = 5000) => {
            notification.textContent = message;
            notification.className = `notification-${type}`;
            notification.classList.remove('hidden');
            if (duration) {
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, duration);
            }
        };
        
        // यूजर की स्थिति जांचें
        const checkUser = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                loginSection.classList.add('hidden');
                recoverySection.classList.remove('hidden');
                fetchRecoveryData();
            } else {
                loginSection.classList.remove('hidden');
                recoverySection.classList.add('hidden');
            }
        };

        // लॉगिन फॉर्म सबमिट होने पर
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginButton.disabled = true;
            loginButton.textContent = 'लॉगिन हो रहा है...';
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            
            if (error) {
                showNotification(`लॉगिन विफल: ${error.message === 'Invalid login credentials' ? 'अमान्य ईमेल या पासवर्ड।' : error.message}`, 'error');
            } else {
                showNotification('सफलतापूर्वक लॉगिन हो गया!', 'success');
                checkUser();
            }
            loginButton.disabled = false;
            loginButton.textContent = 'लॉगिन';
        });

        // लॉगआउट बटन
        logoutButton.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            showNotification('आप सफलतापूर्वक लॉगआउट हो गए हैं।', 'success');
            checkUser();
        });

        // रिकवरी डेटा लाएं
        const fetchRecoveryData = async () => {
            recoveryTableBody.innerHTML = '<tr><td colspan="11" style="text-align:center;">डेटा लोड हो रहा है...</td></tr>';
            
            const { data, error } = await supabaseClient
                .from('recovrybakimember')
                .select('*')
                .order('sn', { ascending: true });

            if (error) {
                showNotification('डेटा लाने में त्रुटि हुई: ' + error.message, 'error');
                recoveryTableBody.innerHTML = '<tr><td colspan="11" style="text-align:center; color:red;">डेटा लोड नहीं हो सका।</td></tr>';
                return;
            }

            if (data.length === 0) {
                recoveryTableBody.innerHTML = '<tr><td colspan="11" style="text-align:center;">कोई बकाया रिकॉर्ड नहीं मिला।</td></tr>';
                return;
            }

            recoveryTableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.sn}</td>
                    <td>${row.adhar_number || ''}</td>
                    <td>${row.name || ''}</td>
                    <td>${row.father_name || ''}</td>
                    <td>${row.account_number || ''}</td>
                    <td>${row.amount || ''}</td>
                    <td>${row.intrestdmr_number || ''}</td>
                    <td>${row.year || ''}</td>
                    <td>${row.recovery_done || ''}</td>
                    <td><button onclick="editRecovery(${row.sn}, '${row.recovery_done || ''}')">संपादित करें</button></td>
                `;
                recoveryTableBody.appendChild(tr);
            });
        };

        // एडिट फंक्शन
        window.editRecovery = (sn, recovery_done) => {
            updateSn.value = sn;
            recoveryDoneInput.value = recovery_done;
            recoveryDoneInput.focus();
            window.scrollTo(0, document.body.scrollHeight);
            showNotification(`रिकॉर्ड नंबर ${sn} को संपादित किया जा रहा है।`, 'info');
        };

        // अपडेट फॉर्म सबमिट होने पर
        updateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            updateButton.disabled = true;
            updateButton.textContent = 'अपडेट हो रहा है...';

            const sn = updateSn.value;
            const recovery_done = recoveryDoneInput.value;
            
            const { error } = await supabaseClient
                .from('recovrybakimember')
                .update({ recovery_done: recovery_done })
                .eq('sn', sn);

            if (error) {
                // यहाँ पर एक टाइपिंग की गलती थी, जिसे ठीक कर दिया गया है।
                showNotification('अपडेट करने में त्रुटि: ' + error.message, 'error');
            } else {
                showNotification('रिकवरी सफलतापूर्वक अपडेट की गई!', 'success');
                fetchRecoveryData();
                updateForm.reset();
            }
            updateButton.disabled = false;
            updateButton.textContent = 'अपडेट करें';
        });

        // पेज लोड होने पर यूजर जांचें
        checkUser();
    </script>

</body>
</html>
