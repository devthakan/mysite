<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>बकाया रिकवरी सूची</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f4f7f6; }
        #app-container { max-width: 1000px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 1px solid #ccc; }
        header h2 { margin: 0; }
        #auth-controls button { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #007bff; color: white; }
        .hidden { display: none; }
        /* Login Modal Styles */
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        #login-form { background-color: white; padding: 30px; border-radius: 8px; width: 300px; }
        input { width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #notification { padding: 15px; margin-bottom: 20px; border-radius: 5px; color: #fff; text-align: center; }
        .notification-success { background-color: #28a745; }
        .notification-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h2>बकाया किसानों की रिकवरी सूची</h2>
            <div id="auth-controls">
                <button id="login-icon" title="एडमिन लॉगिन"><i class="fas fa-user-shield"></i></button>
                <button id="logout-button" class="hidden" title="लॉगआउट"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </header>

        <div id="notification" class="hidden"></div>

        <table id="recovery-table">
            <thead>
                <tr>
                    <th>क्र.सं.</th>
                    <th>नाम</th>
                    <th>पिता का नाम</th>
                    <th>राशि</th>
                    <th>वर्ष</th>
                    <th>रिकवरी हुई?</th>
                    <th class="admin-only hidden">कार्यवाही</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <div id="update-section" class="admin-only hidden">
            <h3>रिकवरी स्टेटस अपडेट करें</h3>
            <form id="update-form">
                <input type="hidden" id="update-sn">
                <label for="recovery_done">रिकवरी हुई (हाँ/नहीं):</label>
                <input type="text" id="recovery_done" required>
                <button type="submit" id="update-button">अपडेट करें</button>
            </form>
        </div>
    </div>

    <div id="login-modal" class="hidden">
        <form id="login-form">
            <h3>एडमिन लॉगिन</h3>
            <label for="email">ईमेल:</label>
            <input type="email" id="email" required>
            <label for="password">पासवर्ड:</label>
            <input type="password" id="password" required>
            <button type="submit">लॉगिन</button>
            <button type="button" id="close-modal-button" style="margin-top: 10px; background-color: grey;">कैंसिल</button>
        </form>
    </div>

    <script>
        const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // HTML एलिमेंट्स
        const loginIcon = document.getElementById('login-icon');
        const logoutButton = document.getElementById('logout-button');
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const closeModalButton = document.getElementById('close-modal-button');
        const recoveryTableBody = document.querySelector('#recovery-table tbody');
        const notification = document.getElementById('notification');
        const adminOnlyElements = document.querySelectorAll('.admin-only');

        // ----- मुख्य फंक्शन -----

        // 1. पेज लोड होते ही डेटा दिखाना
        const fetchAndDisplayData = async () => {
            recoveryTableBody.innerHTML = '<tr><td colspan="6">डेटा लोड हो रहा है...</td></tr>';
            const { data, error } = await supabaseClient.from('recovrybakimember').select('*').order('sn');
            
            if (error) {
                recoveryTableBody.innerHTML = '<tr><td colspan="6" style="color:red;">डेटा लोड नहीं हो सका।</td></tr>';
                return;
            }

            recoveryTableBody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.sn}</td>
                    <td>${row.name || ''}</td>
                    <td>${row.father_name || ''}</td>
                    <td>${row.amount || ''}</td>
                    <td>${row.year || ''}</td>
                    <td>${row.recovery_done || ''}</td>
                    <td class="admin-only hidden">
                        <button onclick="editRecovery(${row.sn}, '${row.recovery_done || ''}')">संपादित करें</button>
                    </td>
                `;
                recoveryTableBody.appendChild(tr);
            });
            // डेटा लोड होने के बाद, यूजर की स्थिति के अनुसार UI अपडेट करें
            checkUserSession();
        };

        // 2. यूजर सेशन जांचना और UI अपडेट करना
        const checkUserSession = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                // यूजर लॉग इन है
                loginIcon.classList.add('hidden');
                logoutButton.classList.remove('hidden');
                adminOnlyElements.forEach(el => el.classList.remove('hidden'));
            } else {
                // यूजर लॉग इन नहीं है
                loginIcon.classList.remove('hidden');
                logoutButton.classList.add('hidden');
                adminOnlyElements.forEach(el => el.classList.add('hidden'));
            }
        };

        // ----- इवेंट लिस्नर -----

        // लॉगिन आइकॉन पर क्लिक
        loginIcon.addEventListener('click', () => {
            loginModal.classList.remove('hidden');
        });

        // Modal बंद करने वाले बटन पर क्लिक
        closeModalButton.addEventListener('click', () => {
            loginModal.classList.add('hidden');
        });

        // लॉगिन फॉर्म सबमिट होने पर
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                alert('लॉगिन विफल: अमान्य ईमेल या पासवर्ड।');
            } else {
                loginModal.classList.add('hidden');
                fetchAndDisplayData(); // UI को तुरंत अपडेट करें
            }
        });

        // लॉगआउट बटन पर क्लिक
        logoutButton.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            fetchAndDisplayData(); // UI को तुरंत अपडेट करें
        });

        // ----- एडमिन फंक्शन -----

        // "संपादित करें" बटन का फंक्शन
        window.editRecovery = (sn, recovery_done) => {
            document.getElementById('update-sn').value = sn;
            document.getElementById('recovery_done').value = recovery_done;
            document.getElementById('update-section').scrollIntoView({ behavior: 'smooth' });
        };

        // अपडेट फॉर्म सबमिट होने पर
        document.getElementById('update-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sn = document.getElementById('update-sn').value;
            const recovery_done = document.getElementById('recovery_done').value;
            
            const { error } = await supabaseClient
                .from('recovrybakimember')
                .update({ recovery_done })
                .eq('sn', sn);

            if (error) {
                alert('अपडेट विफल: ' + error.message);
            } else {
                alert('रिकॉर्ड सफलतापूर्वक अपडेट हो गया!');
                fetchAndDisplayData(); // सूची को ताज़ा करें
            }
        });

        // ----- पेज लोड होने पर पहला काम -----
        fetchAndDisplayData();

    </script>
</body>
</html>
