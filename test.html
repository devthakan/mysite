<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ST Loan Application ‚Äì Apply</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    html, body { background:
      radial-gradient(1200px 800px at 10% 10%, #0ea5e94d, transparent),
      radial-gradient(900px 700px at 90% 20%, #22c55e33, transparent),
      #0b1220; }
    .glass { backdrop-filter: blur(14px); background: rgba(255,255,255,0.06); }
    .hidden { display:none; }
    input[type='date'] { color-scheme: dark; }
    .hint { font-size:.8rem; color:#94a3b8 }
    .caps-only { text-transform: uppercase; }
    .locked { background:rgba(2,6,23,.6); cursor:not-allowed; }
    .focusy:focus { outline:none; box-shadow: 0 0 0 3px rgba(34,197,94,.35); border-color: rgba(255,255,255,.25); }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:50; }
    .pop { animation: pop .28s ease-out both; }
    @keyframes pop{ from{ transform:scale(.9); opacity:0 } to{ transform:scale(1); opacity:1 } }
    .check svg circle { stroke-dasharray: 157; stroke-dashoffset: 157; animation: dash 0.6s ease-out forwards; }
    .check svg path { stroke-dasharray: 50; stroke-dashoffset: 50; animation: dash 0.4s 0.4s ease-out forwards; }
    @keyframes dash{ to{ stroke-dashoffset: 0; } }
    .confetti{ position:fixed; top:-10px; width:8px; height:14px; opacity:.9; transform:rotate(15deg); animation: fall 1.8s linear forwards; z-index:60; }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(360deg); opacity:1; } }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="mb-6 md:mb-8 flex items-center justify-between">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold">ST Loan Application</h1>
        <p class="text-slate-300 mt-1">‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ Lookup ¬∑ WhatsApp OTP ¬∑ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∏‡§¨‡§Æ‡§ø‡§∂‡§®</p>
      </div>
      <a href="index.html" class="text-sm text-emerald-400 hover:text-emerald-300">‚Üê ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂</a>
    </header>

    <form id="appForm" class="glass rounded-2xl p-5 md:p-7 border border-white/10 shadow-2xl" novalidate>
      <!-- ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ Lookup -->
      <div class="mb-6">
        <label class="block text-sm mb-1">‡§Ö‡§™‡§®‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç</label>
        <div class="flex gap-2 items-center">
          <input id="member_no" inputmode="numeric" pattern="\d{1,12}" maxlength="12" class="flex-1 bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" placeholder="‡§â‡§¶‡§æ. 123456" required />
          <button type="button" id="member_fetch" class="px-4 py-2 rounded-xl bg-indigo-500 text-slate-900 font-semibold hover:brightness-110 transition">Find</button>
          <span id="member_status" class="hint ml-2"></span>
        </div>
        <p class="hint mt-1">‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§Æ‡§ø‡§≤‡§®‡•á ‡§™‡§∞ "‡§ï‡•É‡§∑‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ" ‡§î‡§∞ "‡§™‡§ø‡§§‡§æ/‡§™‡§§‡§ø ‡§ï‡§æ ‡§®‡§æ‡§Æ" ‡§Ö‡§™‡§®‡•á-‡§Ü‡§™ ‡§≠‡§∞‡§ï‡§∞ ‡§≤‡•â‡§ï ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§</p>
      </div>

      <!-- Applicant details -->
      <h2 class="text-lg font-semibold mb-3">‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£</h2>
      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div>
          <label class="block text-sm mb-1">‡§ï‡•É‡§∑‡§ï ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</label>
          <select id="kisan_type" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 uppercase focusy" required>
            <option value="">‚Äî ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>
            <option>LAGHU</option>
            <option>SIMANT</option>
            <option>ANY</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">‡§µ‡§∞‡•ç‡§ó</label>
          <select id="caste_cat" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 uppercase focusy" required>
            <option value="">‚Äî ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>
            <option>SC</option>
            <option>ST</option>
            <option>OBC</option>
            <option>GEN</option>
            <option>OTHER</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">‡§ï‡•É‡§∑‡§ï ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
          <input id="farmer_name" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 caps-only locked focusy" pattern="^[A-Z ]+$" readonly />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§™‡§ø‡§§‡§æ / ‡§™‡§§‡§ø ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
          <input id="guardian_name" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 caps-only locked focusy" pattern="^[A-Z ]+$" readonly />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§ú‡§æ‡§§‡§ø</label>
          <input id="jaati" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 caps-only focusy" pattern="^[A-Z ]+$" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z ]/g,'')" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§≤‡§ø‡§Ç‡§ó</label>
          <select id="gender" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 uppercase focusy" required>
            <option value="">‚Äî ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>
            <option>MALE</option>
            <option>FEMALE</option>
          </select>
        </div>
        <div>
          <label class="block text-sm mb-1">‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø</label>
          <input id="dob" type="date" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" required />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§∞‡•á‡§µ‡•á‡§®‡•ç‡§Ø‡•Å ‡§µ‡§ø‡§≤‡•á‡§ú ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
          <input id="rev_village" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 caps-only focusy" pattern="^[A-Z ]+$" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z ]/g,'')" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§ó‡•ç‡§∞‡§æ‡§Æ ‡§™‡§Ç‡§ö‡§æ‡§Ø‡§§</label>
          <input id="gram_panchayat" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 caps-only focusy" pattern="^[A-Z ]+$" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z ]/g,'')" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§¨‡•à‡§Ç‡§ï ‡§ñ‡§æ‡§§‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</label>
          <input id="bank_ac" inputmode="numeric" pattern="\d{17}" maxlength="17" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" required />
          <p class="hint">17 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è</p>
        </div>
        <div>
          <label class="block text-sm mb-1">‡§Ü‡§ß‡§æ‡§∞ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</label>
          <input id="aadhaar" inputmode="numeric" pattern="\d{12}" maxlength="12" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" required />
          <p class="hint">12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡•Ä ‡§Ü‡§ß‡§æ‡§∞ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</p>
        </div>
        <div>
          <label class="block text-sm mb-1">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Æ‡•ç‡§¨‡§∞</label>
          <input id="mobile" inputmode="numeric" pattern="\d{10}" maxlength="10" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" required />
          <p class="hint">10 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§Ç‡§¨‡§∞</p>
        </div>
        <div>
          <label class="block text-sm mb-1">‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§®‡§Ç‡§¨‡§∞</label>
          <input id="whatsapp" inputmode="numeric" pattern="\d{10}" maxlength="10" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§ú‡§® ‡§Ü‡§ß‡§æ‡§∞ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
          <input id="jan_aadhaar" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§µ‡•ã‡§ü‡§∞ ‡§Ü‡§à‡§°‡•Ä (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
          <input id="voter_id" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§™‡•á‡§® ‡§ï‡§æ‡§∞‡•ç‡§° (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</label>
          <input id="pan" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" maxlength="10" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 uppercase focusy" />
          <p class="hint">‡§â‡§¶‡§æ: ABCDE1234F</p>
        </div>
      </div>

      <!-- Nominee details -->
      <h2 class="text-lg font-semibold mb-3">‡§®‡•â‡§Æ‡§ø‡§®‡•Ä ‡§µ‡§ø‡§µ‡§∞‡§£</h2>
      <div class="grid md:grid-cols-3 gap-4 mb-6">
        <div>
          <label class="block text-sm mb-1">‡§®‡•â‡§Æ‡§ø‡§®‡•Ä ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
          <input id="nominee_name" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 caps-only focusy" pattern="^[A-Z ]+$" required oninput="this.value=this.value.toUpperCase().replace(/[^A-Z ]/g,'')" />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§ú‡§®‡•ç‡§Æ ‡§§‡§ø‡§•‡§ø</label>
          <input id="nominee_dob" type="date" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" required />
        </div>
        <div>
          <label class="block text-sm mb-1">‡§ï‡•É‡§∑‡§ï ‡§∏‡•á ‡§∏‡§Ç‡§¨‡§Ç‡§ß</label>
          <select id="nominee_relation" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 uppercase focusy" required>
            <option value="">‚Äî ‡§ö‡•Å‡§®‡•á‡§Ç ‚Äî</option>
            <option>WIFE</option>
            <option>HUS</option>
            <option>SON</option>
            <option>DOU</option>
            <option>BRO</option>
            <option>SIS</option>
            <option>OTHER</option>
          </select>
        </div>
      </div>

      <!-- Witnesses -->
      <h2 class="text-lg font-semibold mb-3">‡§ó‡§µ‡§æ‡§π ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£</h2>
      <p class="hint mb-4">‡§ó‡§µ‡§æ‡§π Excel/CSV ‡§™‡§π‡§≤‡•á ‡§∏‡•á <strong>witness_master</strong> ‡§§‡§æ‡§≤‡§ø‡§ï‡§æ ‡§Æ‡•á‡§Ç ‡§π‡•ã‡§Ç‡•§ ‡§Ü‡§ß‡§æ‡§∞ ‡§°‡§æ‡§≤‡§ï‡§∞ Find ‡§ï‡§∞‡•á‡§Ç, ‡§®‡§æ‡§Æ/‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ auto-fill ‡§π‡•ã‡§ó‡§æ‡•§ WhatsApp OTP verify ‡§ú‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡•§</p>
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div class="border border-white/10 rounded-2xl p-4 bg-slate-900/40">
          <h3 class="font-semibold mb-3">‡§ó‡§µ‡§æ‡§π 1</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm mb-1">‡§Ü‡§ß‡§æ‡§∞ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</label>
              <div class="flex gap-2">
                <input id="w1_aadhaar" inputmode="numeric" maxlength="12" pattern="\d{12}" class="flex-1 bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" placeholder="12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Ü‡§ß‡§æ‡§∞" />
                <button type="button" id="w1_fetch" class="px-3 rounded-lg bg-slate-700 hover:bg-slate-600">Find</button>
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1">‡§®‡§æ‡§Æ</label>
              <input id="w1_name" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" readonly />
            </div>
            <div>
              <label class="block text-sm mb-1">‡§™‡§ø‡§§‡§æ/‡§™‡§§‡§ø ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
              <input id="w1_guardian_name" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" readonly />
            </div>
            <div>
              <label class="block text-sm mb-1">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label>
              <input id="w1_mobile" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" readonly />
            </div>
            <div class="flex gap-2 items-end">
              <div class="flex-1">
                <label class="block text-sm mb-1">OTP</label>
                <input id="w1_otp" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" placeholder="6-digit" maxlength="6" />
              </div>
              <button type="button" id="w1_send_otp" class="px-3 rounded-lg bg-emerald-600 hover:brightness-110">Send OTP</button>
              <button type="button" id="w1_verify" class="px-3 rounded-lg bg-indigo-600 hover:brightness-110">Verify</button>
            </div>
            <p id="w1_status" class="hint" data-ok="0"></p>
          </div>
        </div>

        <div class="border border-white/10 rounded-2xl p-4 bg-slate-900/40">
          <h3 class="font-semibold mb-3">‡§ó‡§µ‡§æ‡§π 2</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm mb-1">‡§Ü‡§ß‡§æ‡§∞ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ</label>
              <div class="flex gap-2">
                <input id="w2_aadhaar" inputmode="numeric" maxlength="12" pattern="\d{12}" class="flex-1 bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy" placeholder="12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Ü‡§ß‡§æ‡§∞" />
                <button type="button" id="w2_fetch" class="px-3 rounded-lg bg-slate-700 hover:bg-slate-600">Find</button>
              </div>
            </div>
            <div>
              <label class="block text-sm mb-1">‡§®‡§æ‡§Æ</label>
              <input id="w2_name" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" readonly />
            </div>
            <div>
              <label class="block text-sm mb-1">‡¶™‡§ø‡§§‡§æ/‡§™‡§§‡§ø ‡§ï‡§æ ‡§®‡§æ‡§Æ</label>
              <input id="w2_guardian_name" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" readonly />
            </div>
            <div>
              <label class="block text-sm mb-1">‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤</label>
              <input id="w2_mobile" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" readonly />
            </div>
            <div class="flex gap-2 items-end">
              <div class="flex-1">
                <label class="block text-sm mb-1">OTP</label>
                <input id="w2_otp" class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3" placeholder="6-digit" maxlength="6" />
              </div>
              <button type="button" id="w2_send_otp" class="px-3 rounded-lg bg-emerald-600 hover:brightness-110">Send OTP</button>
              <button type="button" id="w2_verify" class="px-3 rounded-lg bg-indigo-600 hover:brightness-110">Verify</button>
            </div>
            <p id="w2_status" class="hint" data-ok="0"></p>
          </div>
        </div>
      </div>

      <div class="mt-6 flex flex-col md:flex-row md:justify-between gap-3">
        <div class="text-sm text-slate-400">‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§Ü‡§è‡§ó‡§æ‚Äî<em>‚Äú‡§Ü‡§™‡§ï‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ‚Äù</em> ‡§î‡§∞ <strong>Application Number = ‡§Ü‡§™‡§ï‡§æ ‡§Ü‡§ß‡§æ‡§∞ ‡§®‡§Ç‡§¨‡§∞</strong>‡•§ Download ‡§™‡•á‡§ú ‡§Æ‡•á‡§Ç ‡§Ø‡§π ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡§ï‡§∞ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§</div>
        <div class="flex gap-3">
          <button type="submit" id="submitBtn" class="px-5 py-3 rounded-xl bg-emerald-500 text-slate-900 font-semibold hover:brightness-110" disabled>‡§∏‡§¨‡§Æ‡§ø‡§ü</button>
        </div>
      </div>
    </form>

    <div id="toast" class="hidden fixed bottom-5 right-5 bg-black/80 text-white px-4 py-2 rounded-lg"></div>

    <!-- Success Modal -->
    <div id="success_modal" class="hidden modal-backdrop">
      <div class="bg-slate-900/90 border border-white/10 rounded-2xl p-6 md:p-8 w-full max-w-md pop text-center">
        <div class="check mx-auto mb-4">
          <svg width="84" height="84" viewBox="0 0 84 84" fill="none">
            <circle cx="42" cy="42" r="25" stroke="#22c55e" stroke-width="4" fill="none" />
            <path d="M32 43.5 L40 51 L54 35" stroke="#22c55e" stroke-width="4" fill="none" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </div>
        <h3 class="text-xl font-bold">‡§Ü‡§™‡§ï‡§æ ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ó‡§Ø‡§æ üéâ</h3>
        <p class="text-slate-300 mt-2">Application Number (‡§Ü‡§ß‡§æ‡§∞): <span id="success_app_no" class="font-semibold text-emerald-400"></span></p>
        <p class="text-slate-400 text-sm mt-1">‡§á‡§∏‡•á ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§ø‡§§ ‡§∞‡§ñ‡•á‡§Ç‡•§ Download ‡§™‡•á‡§ú ‡§™‡§∞ ‡§Ø‡§π ‡§®‡§Ç‡§¨‡§∞ ‡§°‡§æ‡§≤‡§ï‡§∞ ‡§Ö‡§™‡§®‡§æ ‡§´‡§º‡•â‡§∞‡•ç‡§Æ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§</p>
        <div class="mt-5 flex justify-center gap-3">
          <a id="go_download" href="download.html" class="px-4 py-2 rounded-lg bg-indigo-500 text-slate-900 font-semibold">Download ‡§™‡•á‡§ú</a>
          <button id="success_close" class="px-4 py-2 rounded-lg bg-slate-700">‡§†‡•Ä‡§ï ‡§π‡•à</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co"; // ‡§Ö‡§™‡§®‡§æ
    const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY"; // ‡§Ö‡§™‡§®‡§æ (anon), service role ‡§ï‡§≠‡•Ä ‡§®‡§π‡•Ä‡§Ç

    const DOWNLOAD_URL = localStorage.getItem('loan.download_url') || 'download.html';
    const MEMBERS_TABLE = 'members';
    const WITNESS_TABLE = 'witness_master';
    const APPLICATIONS  = 'applications';

    // Edge Functions
    const FN_SEND_OTP   = 'send-otp';
    const FN_VERIFY_OTP = 'verify-otp'; // ‡§Æ‡§æ‡§® ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å ‡§Ø‡§π ‡§≠‡•Ä ‡§°‡§ø‡§™‡•ç‡§≤‡•â‡§Ø ‡§π‡•à

    /* ========= Helpers ========= */
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');
    const toast = (msg) => { const t=$('toast'); t.textContent=msg; show(t); setTimeout(()=>hide(t), 2600); };
    const onlyDigits = (s) => (s||'').replace(/\D+/g,'');
    const upperAZ = (s) => (s||'').toUpperCase().replace(/[^A-Z ]+/g,'').trim();
    const validAadhaar = s => /^\d{12}$/.test(s||"");
    const validMobile10 = s => /^[6-9]\d{9}$/.test(s||"");

    let sb = null;
    function fromTbl(name){ return sb.from(name); }

    /* ========= Membership Lookup ========= */
    let membershipOk = false;
    function lockNames(){ $('farmer_name').readOnly = true; $('guardian_name').readOnly = true; $('farmer_name').classList.add('locked'); $('guardian_name').classList.add('locked'); }
    function unlockNames(){ $('farmer_name').readOnly = false; $('guardian_name').readOnly = false; $('farmer_name').classList.remove('locked'); $('guardian_name').classList.remove('locked'); $('farmer_name').value=''; $('guardian_name').value=''; }

    function toastDetail(prefix, err){
      const msg = [err?.code, err?.message, err?.details, err?.hint].filter(Boolean).join(' | ');
      toast(`${prefix}: ${msg || 'unknown'}`.slice(0,180));
    }

    async function fetchMember(){
      const raw = $('member_no').value.trim();
      if(!raw){ $('member_status').textContent='‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç'; membershipOk=false; return; }
      let res = await fromTbl(MEMBERS_TABLE).select('farmer_name, guardian_name').eq('membership_no', raw).limit(1).maybeSingle();
      if((!res.data && !res.error) && /^\d+$/.test(raw)){
        res = await fromTbl(MEMBERS_TABLE).select('farmer_name, guardian_name').eq('membership_no', Number(raw)).limit(1).maybeSingle();
      }
      if(res.error){ console.error(res.error); $('member_status').textContent='Lookup error'; toastDetail('Members lookup', res.error); membershipOk=false; unlockNames(); return; }
      if(!res.data){ $('member_status').textContent='‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ'; membershipOk=false; unlockNames(); return; }
      $('farmer_name').value = upperAZ(res.data.farmer_name||'');
      $('guardian_name').value = upperAZ(res.data.guardian_name||'');
      lockNames(); $('member_status').textContent='‡§Æ‡§ø‡§≤‡§æ ‚úî'; membershipOk=true; setSubmitEnabled();
    }

    /* ========= Witness Lookup ========= */
    function setSubmitEnabled(){ const ok1 = $('w1_status').dataset.ok === '1'; const ok2 = $('w2_status').dataset.ok === '1'; $('submitBtn').disabled = !(ok1 && ok2 && membershipOk); }

    async function fetchWitness(slot){
      const aadhaar = onlyDigits($(slot+'_aadhaar').value);
      $(slot+'_aadhaar').value = aadhaar;
      if(!validAadhaar(aadhaar)){ toast('12 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§Ü‡§ß‡§æ‡§∞ ‡§°‡§æ‡§≤‡•á‡§Ç'); return; }
      const appA  = onlyDigits($('aadhaar').value);
      const other = slot==='w1' ? onlyDigits($('w2_aadhaar').value) : onlyDigits($('w1_aadhaar').value);
      if(aadhaar===appA){ toast('‡§ó‡§µ‡§æ‡§π ‡§ï‡§æ ‡§Ü‡§ß‡§æ‡§∞ ‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ú‡•à‡§∏‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ'); return; }
      if(other && aadhaar===other){ toast('‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ó‡§µ‡§æ‡§π‡•ã‡§Ç ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§Ö‡§≤‡§ó ‡§π‡•ã‡§®‡•á ‡§ö‡§æ‡§π‡§ø‡§è'); return; }
      const q = await fromTbl(WITNESS_TABLE).select('name, guardian_name, mobile').eq('aadhaar', aadhaar).limit(1).maybeSingle();
      if(q.error){ console.error(q.error); toastDetail('Witness lookup', q.error); return; }
      if(!q.data){ toast('‡§ó‡§µ‡§æ‡§π ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ'); return; }
      $(slot+'_name').value = upperAZ(q.data.name||'');
      $(slot+'_guardian_name').value = upperAZ(q.data.guardian_name||'');
      $(slot+'_mobile').value = onlyDigits(q.data.mobile||'');
      toast('‡§ó‡§µ‡§æ‡§π ‡§Æ‡§ø‡§≤‡§æ');
    }

    /* ========= OTP via Edge Functions ========= */
    function toE164(m){ const d=onlyDigits(m||''); if(d.length===10) return '+91'+d; if(d.length===12 && d.startsWith('91')) return '+'+d; if((m||'').startsWith('+')) return m; return '+91'+d; }

    async function sendOtpEdge(mobile, context){
      const to = toE164(mobile);
      if(!/^\+?\d{11,15}$/.test(to)){ toast('‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§®‡§π‡•Ä‡§Ç'); return false; }
      const { data, error } = await sb.functions.invoke(FN_SEND_OTP, { body: { mobile: to, context }});
      if(error){ console.error('send-otp error', error); toast(`OTP ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ [${error.status||'ERR'}] ${error.message||''}`); return false; }
      if(!data?.ok){ console.error('send-otp resp', data); toast(`OTP ‡§≠‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ${data?.reason?`(${data.reason})`:''}`); return false; }
      toast('OTP ‡§≠‡•á‡§ú ‡§¶‡•Ä ‡§ó‡§à'); return true;
    }

    async function verifyOtpEdge(mobile, otp, context){
      const to = toE164(mobile);
      const code = onlyDigits(otp);
      if(!/^\+?\d{11,15}$/.test(to) || !/^\d{6}$/.test(code)){ toast('OTP ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡§π‡•Ä ‡§ï‡§∞‡•á‡§Ç'); return false; }
      const { data, error } = await sb.functions.invoke(FN_VERIFY_OTP, { body: { mobile: to, otp: code, context }});
      if(error){ console.error('verify-otp error', error); toast(`OTP ‡§ó‡§≤‡§§/‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞ [${error.status||'ERR'}] ${error.message||''}`); return false; }
      if(!data?.ok){ console.error('verify-otp resp', data); toast(`OTP ‡§ó‡§≤‡§§/‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞ ${data?.reason?`(${data.reason})`:''}`); return false; }
      toast('Verified ‚úî'); return true;
    }

    /* ========= Success UI ========= */
    function confettiBurst(){
      const colors = ['#22c55e','#a3e635','#34d399','#60a5fa','#f472b6','#f59e0b'];
      for(let i=0;i<60;i++){
        const s = document.createElement('div'); s.className='confetti';
        s.style.left = Math.random()*100+'vw'; s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.transform = `rotate(${Math.random()*360}deg)`; s.style.animationDuration = (1.4 + Math.random()*0.8)+'s';
        document.body.appendChild(s); setTimeout(()=>s.remove(), 2200);
      }
    }
    function openSuccess(appNo){ $('success_app_no').textContent = appNo || ''; $('go_download').href = DOWNLOAD_URL; show($('success_modal')); confettiBurst(); }
    function closeSuccess(){ hide($('success_modal')); }

    /* ========= Submit ========= */
    async function submitApp(e){
      e.preventDefault();
      if(!membershipOk){ toast('‡§™‡§π‡§≤‡•á ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§§‡§æ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ verify ‡§ï‡§∞‡•á‡§Ç'); return; }
      const ac=onlyDigits($('bank_ac').value), ad=onlyDigits($('aadhaar').value), mob=onlyDigits($('mobile').value);
      if(!/^\d{17}$/.test(ac)){ toast('‡§ñ‡§æ‡§§‡§æ 17 digits'); return; }
      if(!validAadhaar(ad)){ toast('‡§Ü‡§ß‡§æ‡§∞ 12 digits'); return; }
      if(!/^\d{10}$/.test(mob)){ toast('‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ 10 digits'); return; }
      const w1a = onlyDigits($('w1_aadhaar').value), w2a = onlyDigits($('w2_aadhaar').value);
      if(w1a && ad && w1a===ad){ toast('‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ñ‡•Å‡§¶ ‡§ó‡§µ‡§æ‡§π ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ (‡§ó‡§µ‡§æ‡§π 1)'); return; }
      if(w2a && ad && w2a===ad){ toast('‡§Ü‡§µ‡•á‡§¶‡§ï ‡§ñ‡•Å‡§¶ ‡§ó‡§µ‡§æ‡§π ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ (‡§ó‡§µ‡§æ‡§π 2)'); return; }
      if(w1a && w2a && w1a===w2a){ toast('‡§è‡§ï ‡§π‡•Ä ‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡§ø ‡§¶‡•ã ‡§¨‡§æ‡§∞ ‡§ó‡§µ‡§æ‡§π ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ'); return; }
      if($('w1_status').dataset.ok!=='1' || $('w2_status').dataset.ok!=='1'){ toast('‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ó‡§µ‡§æ‡§π OTP ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ú‡§∞‡•Ç‡§∞‡•Ä'); return; }

      const payload = {
        membership_no: $('member_no').value.trim(), kisan_type: $('kisan_type').value, caste_cat: $('caste_cat').value,
        farmer_name: $('farmer_name').value, guardian_name: $('guardian_name').value, jaati: $('jaati').value,
        gender: $('gender').value, dob: $('dob').value, rev_village: $('rev_village').value, gram_panchayat: $('gram_panchayat').value,
        bank_ac: ac, aadhaar: ad, mobile: mob, whatsapp: onlyDigits($('whatsapp').value),
        jan_aadhaar: $('jan_aadhaar').value, voter_id: $('voter_id').value, pan: ($('pan').value||'').toUpperCase(),
        nominee_name: $('nominee_name').value, nominee_dob: $('nominee_dob').value, nominee_relation: $('nominee_relation').value,
        w1_aadhaar: w1a, w1_name: $('w1_name').value, w1_guardian_name: $('w1_guardian_name').value, w1_mobile: onlyDigits($('w1_mobile').value),
        w2_aadhaar: w2a, w2_name: $('w2_name').value, w2_guardian_name: $('w2_guardian_name').value, w2_mobile: onlyDigits($('w2_mobile').value),
        w1_verified: $('w1_status').dataset.ok==='1', w2_verified: $('w2_status').dataset.ok==='1', status: 'submitted'
      };

      const ins = await fromTbl(APPLICATIONS).insert(payload);
      if(ins.error){ console.error(ins.error); toast('Save error (policies/columns)'); return; }

      openSuccess(ad);

      // reset
      e.target.reset();
      $('w1_status').textContent=''; $('w2_status').textContent='';
      $('w1_status').dataset.ok='0'; $('w2_status').dataset.ok='0';
      membershipOk=false; $('member_status').textContent='';
      $('farmer_name').readOnly=false; $('guardian_name').readOnly=false;
      $('farmer_name').classList.remove('locked'); $('guardian_name').classList.remove('locked');
      $('submitBtn').disabled = true;
    }

    /* ========= Bootstrap ========= */
    (function start(){
      const init = async () => {
        if(!window.supabase || !window.supabase.createClient){ toast('Supabase JS load error'); return; }
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // üîê ‡§Ö‡§ó‡§∞ send-otp ‡§ï‡•ã verify-jwt ON ‡§ï‡•á ‡§∏‡§æ‡§• deploy ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à, ‡§§‡•ã anonymous sign-in ‡§ï‡§∞‡•á‡§Ç
        try{
          const { error } = await sb.auth.signInAnonymously();
          if(error){ console.error(error); toast('Auth error (anonymous)'); }
        }catch(e){ console.error(e); }

        $('member_fetch').addEventListener('click', fetchMember);
        $('member_no').addEventListener('input', ()=>{ $('member_status').textContent=''; membershipOk=false; $('submitBtn').disabled=true; });

        $('w1_fetch').onclick = () => fetchWitness('w1');
        $('w2_fetch').onclick = () => fetchWitness('w2');

        $('w1_send_otp').onclick = async () => {
          const m = onlyDigits($('w1_mobile').value);
          if(!validMobile10(m)){ toast('‡§ó‡§µ‡§æ‡§π 1 ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç'); return; }
          await sendOtpEdge(m, 'w1');
        };
        $('w2_send_otp').onclick = async () => {
          const m = onlyDigits($('w2_mobile').value);
          if(!validMobile10(m)){ toast('‡§ó‡§µ‡§æ‡§π 2 ‡§ï‡§æ ‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤ ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§®‡§π‡•Ä‡§Ç'); return; }
          await sendOtpEdge(m, 'w2');
        };
        $('w1_verify').onclick = async () => {
          const ok = await verifyOtpEdge($('w1_mobile').value, $('w1_otp').value, 'w1');
          $('w1_status').textContent = ok ? '‡§ó‡§µ‡§æ‡§π 1 ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‚úî' : 'OTP ‡§ó‡§≤‡§§/‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞';
          $('w1_status').dataset.ok = ok ? '1' : '0'; setSubmitEnabled();
        };
        $('w2_verify').onclick = async () => {
          const ok = await verifyOtpEdge($('w2_mobile').value, $('w2_otp').value, 'w2');
          $('w2_status').textContent = ok ? '‡§ó‡§µ‡§æ‡§π 2 ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‚úî' : 'OTP ‡§ó‡§≤‡§§/‡§è‡§ï‡•ç‡§∏‡§™‡§æ‡§Ø‡§∞';
          $('w2_status').dataset.ok = ok ? '1' : '0'; setSubmitEnabled();
        };

        $('appForm').addEventListener('submit', submitApp);
        $('success_close').addEventListener('click', closeSuccess);
        $('go_download').href = DOWNLOAD_URL;
      };
      if(document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(init,0);
      else window.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
