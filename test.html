<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>рд░рд┐рдХрд╡рд░реА рдмрдХрд╛рдпрд╛ рд╕реВрдЪреА</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
  /* рдмреЗрд╕рд┐рдХ, рд╕реЙрд▓рд┐рдб UI */
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Noto Sans Devanagari;background:#f6f7fb;color:#111}
  header{position:sticky;top:0;z-index:1000;background:#4f46e5;color:#fff;display:flex;justify-content:space-between;align-items:center;padding:10px 12px}
  header h1{margin:0;font-size:18px}
  .right{display:flex;gap:8px;align-items:center}
  #loginToggle{border:0;background:#fff;color:#4f46e5;border-radius:8px;padding:6px 10px;cursor:pointer}
  #authBadge{display:none;font-size:12px;background:#22c55e;color:#fff;border-radius:999px;padding:2px 8px}
  .wrap{max-width:1100px;margin:12px auto;padding:0 10px}

  /* Login panel */
  #loginBox{display:none;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;max-width:360px;margin:10px 0 0 auto}
  #loginBox input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin:6px 0}
  #loginBox button{width:100%;padding:10px;border:0;border-radius:8px;background:#4f46e5;color:#fff;cursor:pointer}
  #logoutBtn{display:none;background:#ef4444 !important;margin-top:8px}

  /* Toolbar */
  .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:10px 0}
  .btn{border:0;border-radius:8px;padding:8px 12px;color:#fff;cursor:pointer}
  .btn-refresh{background:#0ea5e9}
  .btn-add{background:#22c55e;display:none}
  .btn-top-logout{background:#ef4444;display:none}

  /* Table */
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eef2ff;text-align:center}
  th{background:#eef2ff}
  .badge{padding:4px 8px;border-radius:999px;font-size:12px;display:inline-block}
  .done{background:#dcfce7;color:#065f46}
  .pending{background:#fff7ed;color:#9a3412}
  .action{border:0;border-radius:6px;padding:6px 10px;color:#fff;cursor:pointer;margin:0 2px}
  .edit{background:#3b82f6}.del{background:#ef4444}.mark{background:#f59e0b}
  .locked{color:#9ca3af}

  /* Modal (рд╕реБрдкрд░ рд╕рд┐рдВрдкрд▓, рдХреЛрдИ рдмреНрд▓реЙрдХрд┐рдВрдЧ рдЗрд╢реВ рдирд╣реАрдВ) */
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:2000;
         align-items:center;justify-content:center}
  .dialog{width:96%;max-width:720px;background:#fff;border-radius:10px;border:1px solid #e5e7eb;display:flex;flex-direction:column;max-height:90vh}
  .dialog header{padding:10px 12px;font-weight:600;border-bottom:1px solid #e5e7eb}
  .dialog .content{padding:12px;overflow:auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .col{display:flex;flex-direction:column}
  .col label{font-size:13px;color:#374151;margin-bottom:4px}
  .col input,.col select{padding:10px;border:1px solid #d1d5db;border-radius:8px}
  .dialog .actions{position:sticky;bottom:0;background:#fff;border-top:1px solid #e5e7eb;
                   display:flex;gap:8px;justify-content:flex-end;padding:10px}
  .btn-secondary{background:#6b7280}
  @media(max-width:680px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>рд░рд┐рдХрд╡рд░реА рдмрдХрд╛рдпрд╛ рд╕реВрдЪреА</h1>
  <div class="right">
    <span id="authIcon">ЁЯФТ</span>
    <span id="authBadge"></span>
    <button id="loginToggle">Login</button>
  </div>
</header>

<div class="wrap">
  <!-- Login -->
  <div id="loginBox">
    <h3 style="margin:0 0 6px 0">рд▓реЙрдЧ-рдЗрди</h3>
    <form id="loginForm">
      <input id="email" type="email" placeholder="Email" required>
      <input id="password" type="password" placeholder="Password" required>
      <button id="loginBtn" type="submit">Login</button>
    </form>
    <button id="logoutBtn">Logout</button>
    <small style="display:block;margin-top:6px;color:#6b7280">Signup рдмрдВрдж рд╣реИ тАФ рдХреЗрд╡рд▓ рдЕрдзрд┐рдХреГрдд users login рдХрд░реЗрдВрдЧреЗред</small>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <button id="refreshBtn" class="btn btn-refresh">Refresh</button>
    <button id="addBtn" class="btn btn-add">+ рдирдпрд╛ рд░рд┐рдХреЙрд░реНрдб</button>
    <button id="topLogoutBtn" class="btn btn-top-logout">Logout</button>
  </div>

  <!-- Table -->
  <table>
    <thead>
      <tr>
        <th>S.N.</th>
        <th>рдЖрдзрд╛рд░ рдирдВрдмрд░</th>
        <th>рдирд╛рдо</th>
        <th>рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо</th>
        <th>рдЦрд╛рддрд╛ рдирдВрдмрд░</th>
        <th>рд░рд╛рд╢рд┐</th>
        <th>DMR рдирдВрдмрд░</th>
        <th>рд╡рд░реНрд╖</th>
        <th>рд╕реНрдерд┐рддрд┐</th>
        <th>рдХрд╛рд░реНрдпрд╡рд╛рд╣реА</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<!-- Modal -->
<div id="modal" aria-hidden="true">
  <div class="dialog">
    <header id="modalTitle">рд░рд┐рдХреЙрд░реНрдб</header>
    <div class="content">
      <input type="hidden" id="rowId">
      <div class="grid">
        <div class="col"><label>рдЖрдзрд╛рд░ рдирдВрдмрд░ (12)</label><input id="f_adhar" maxlength="12"></div>
        <div class="col"><label>рдирд╛рдо</label><input id="f_name"></div>
        <div class="col"><label>рдкрд┐рддрд╛ рдХрд╛ рдирд╛рдо</label><input id="f_father"></div>
        <div class="col"><label>рдЦрд╛рддрд╛ рдирдВрдмрд░</label><input id="f_account" maxlength="20"></div>
        <div class="col"><label>рд░рд╛рд╢рд┐</label><input id="f_amount" type="number" step="0.01"></div>
        <div class="col"><label>DMR рдирдВрдмрд░</label><input id="f_dmr"></div>
        <div class="col"><label>рд╡рд░реНрд╖</label><input id="f_year" type="number" placeholder="2025"></div>
        <div class="col"><label>рд░рд┐рдХрд╡рд░реА рд╕реНрдерд┐рддрд┐</label>
          <select id="f_done"><option value="false">Pending</option><option value="true">Done</option></select>
        </div>
      </div>
    </div>
    <div class="actions">
      <button id="cancelBtn" class="btn btn-secondary" type="button">рд░рджреНрдж</button>
      <button id="saveBtn" class="btn btn-add" type="button">ЁЯТ╛ рд╕реЗрд╡</button>
    </div>
  </div>
</div>

<script>
/** ====== CONFIG: рдЕрдкрдиреА keys рднрд░реЛ ====== */
const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
┬а auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey:"recovrybakimember-auth-v1" }
});

/** ====== STATE ====== */
let user = null;
let busy = false;
let editMode = 'create'; // 'create' | 'edit'

/** ====== HELPERS ====== */
const $ = s => document.querySelector(s);
function setAuthUI(){
┬а const logged = !!user;
┬а $('#authIcon').textContent = logged ? 'тЬЕ' : 'ЁЯФТ';
┬а $('#authBadge').style.display = logged && user.email ? 'inline-block' : 'none';
┬а if(logged && user.email) $('#authBadge').textContent = user.email;
┬а $('#addBtn').style.display = logged ? 'inline-block' : 'none';
┬а $('#topLogoutBtn').style.display = logged ? 'inline-block' : 'none';
┬а $('#logoutBtn').style.display = logged ? 'block' : 'none';
  // рдЬрдм рдпреВрдЬрд░ рд▓реЙрдЧ рдЗрди рд╣реЛ рддреЛ 'Login' рдмрдЯрди рдХреЛ 'Close' рдореЗрдВ рдмрджрд▓реЗрдВ
  $('#loginToggle').textContent = logged ? 'Close' : 'Login';
}
function toggleLogin(){
┬а const box = $('#loginBox');
  // рдЕрдЧрд░ рдпреВрдЬрд░ рдкрд╣рд▓реЗ рд╕реЗ рд▓реЙрдЧ рдЗрди рд╣реИ, рддреЛ loginToggle рдмрдЯрди рд╕рд┐рд░реНрдл рдкреИрдирд▓ рдХреЛ рдмрдВрдж рдХрд░реЗрдЧрд╛
  if(user) {
    box.style.display = 'none';
    return;
  }
┬а box.style.display = (box.style.display==='block') ? 'none' : 'block';
}
function openModal(){ $('#modal').style.display = 'flex'; $('#modal').setAttribute('aria-hidden','false'); }
function closeModal(){ $('#modal').style.display = 'none'; $('#modal').setAttribute('aria-hidden','true'); }
function clearForm(){
┬а $('#rowId').value=''; $('#f_adhar').value=''; $('#f_name').value='';
┬а $('#f_father').value=''; $('#f_account').value=''; $('#f_amount').value='';
┬а $('#f_dmr').value=''; $('#f_year').value=''; $('#f_done').value='false';
}
function validateForm(){
┬а const adhar = $('#f_adhar').value.trim();
┬а const name┬а = $('#f_name').value.trim();
┬а const amount= $('#f_amount').value.trim();
┬а const year┬а = $('#f_year').value.trim();
┬а if(adhar.length!==12 || !/^\d{12}$/.test(adhar)){ alert('рдЖрдзрд╛рд░ 12 рдЕрдВрдХреЛрдВ рдХрд╛ рдЪрд╛рд╣рд┐рдП'); return false; }
┬а if(!name){ alert('рдирд╛рдо рдЖрд╡рд╢реНрдпрдХ рд╣реИ'); return false; }
┬а if(amount && isNaN(Number(amount))){ alert('рд░рд╛рд╢рд┐ рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рд╣реЛ'); return false; }
┬а if(year && (+year<1900 || +year>2100)){ alert('рд╡рд░реНрд╖ рдорд╛рдиреНрдп рдирд╣реАрдВ'); return false; }
┬а return true;
}

/** ====== AUTH ====== */
sb.auth.onAuthStateChange(async (_event, session) => {
┬а user = session?.user ?? null;
┬а setAuthUI();
┬а await loadData(); // Auth state рдмрджрд▓рддреЗ рд╣реА рдбреЗрдЯрд╛ рд░реАрд▓реЛрдб рдХрд░реЗрдВ
});


async function doLogin(){
┬а if(busy) return; busy = true;
┬а const btn = $('#loginBtn'); const old = btn.textContent; btn.disabled = true; btn.textContent = 'рд▓реЙрдЧ-рдЗрди...';
┬а try{
┬а ┬а const email = $('#email').value.trim();
┬а ┬а const password = $('#password').value;
┬а ┬а const { data, error } = await sb.auth.signInWithPassword({ email, password });
┬а ┬а if(error) throw error;
┬а ┬а // onAuthStateChange рдмрд╛рдХреА рдХрд╛рдо рдХрд░реЗрдЧрд╛, рд▓реЗрдХрд┐рди рддреБрд░рдВрдд UI рдЕрдкрдбреЗрдЯ рдХреЗ рд▓рд┐рдП...
    $('#loginBox').style.display='none';
┬а }catch(e){ alert('Login failed: '+(e.message||'unknown error')); }
┬а finally{ btn.disabled=false; btn.textContent=old; busy=false; }
}

async function doLogout(){
┬а if(busy) return; busy = true;
  // рджреЛрдиреЛрдВ рд▓реЙрдЧрдЖрдЙрдЯ рдмрдЯрди рдХреЛ рдЕрд╕реНрдерд╛рдпреА рд░реВрдк рд╕реЗ рдбрд┐рд╕реЗрдмрд▓ рдХрд░реЗрдВ
  $('#logoutBtn').disabled = true;
  $('#topLogoutBtn').disabled = true;
┬а try{
    // signOut() рдХреЙрд▓ рдХрд░рдирд╛ рд╣реА рдХрд╛рдлреА рд╣реИред
┬а ┬а const { error } = await sb.auth.signOut();
┬а ┬а if (error) throw error;
    // onAuthStateChange рдЗрд╡реЗрдВрдЯ UI рдХреЛ рдЕрдкрдиреЗ рдЖрдк рдЕрдкрдбреЗрдЯ рдХрд░ рджреЗрдЧрд╛ред
    $('#loginBox').style.display='none'; // рд▓реЙрдЧрдЖрдЙрдЯ рдХреЗ рдмрд╛рдж рд▓реЙрдЧрд┐рди рдкреИрдирд▓ рдмрдВрдж рдХрд░ рджреЗрдВ
┬а }catch(e){
    alert('Logout error: ' + (e.message || 'unknown error'));
  } finally {
    busy = false;
    // рдмрдЯрди рдХреЛ рдлрд┐рд░ рд╕реЗ рдЗрдиреЗрдмрд▓ рдХрд░рдиреЗ рдХреА рдЬрд░реВрд░рдд рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ UI рдЕрдкрдбреЗрдЯ рд╣реЛрдХрд░ рд╡реЗ рдЧрд╛рдпрдм рд╣реЛ рдЬрд╛рдПрдВрдЧреЗ
  }
}

/** ====== DATA ====== */
async function loadData(){
  const tb = $('#tbody');
  tb.innerHTML = '<tr><td colspan="10">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</td></tr>';
┬а const { data, error } = await sb.from('recovrybakimember').select('*').order('id',{ascending:true});
┬а if(error){
    alert('Data load error: '+error.message);
    tb.innerHTML = '<tr><td colspan="10">рдбреЗрдЯрд╛ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛ рд╕рдХрд╛ред</td></tr>';
    return;
  }
┬а tb.innerHTML=''; // рдкреБрд░рд╛рдирд╛ рдбреЗрдЯрд╛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ
┬а (data||[]).forEach(r=>{
┬а ┬а const tr = document.createElement('tr');
┬а ┬а tr.innerHTML = `
┬а ┬а ┬а <td>${r.sn ?? ''}</td>
┬а ┬а ┬а <td>${r.adhar_number ?? ''}</td>
┬а ┬а ┬а <td>${r.name ?? ''}</td>
┬а ┬а ┬а <td>${r.father_name ?? ''}</td>
┬а ┬а ┬а <td>${r.account_number ?? ''}</td>
┬а ┬а ┬а <td>${r.amount ?? ''}</td>
┬а ┬а ┬а <td>${r.intrestdmr_number ?? ''}</td>
┬а ┬а ┬а <td>${r.year ?? ''}</td>
┬а ┬а ┬а <td>${r.recovery_done ? '<span class="badge done">тЬФя╕П Done</span>' : '<span class="badge pending">тП│ Pending</span>'}</td>
┬а ┬а ┬а <td>${
┬а ┬а ┬а ┬а user
┬а ┬а ┬а ┬а ? `<button class="action edit" data-id="${r.id}">Edit</button>
┬а ┬а ┬а ┬а ┬а ┬а<button class="action del" data-id="${r.id}">Delete</button>
┬а ┬а ┬а ┬а ┬а ┬а<button class="action mark" data-id="${r.id}">Done</button>`
┬а ┬а ┬а ┬а : '<span class="locked">ЁЯФТ</span>'
┬а ┬а ┬а }</td>`;
┬а ┬а tb.appendChild(tr);
┬а });
}

/** ====== CRUD ====== */
async function openCreate(){
┬а if(!user) return alert('Login рдЖрд╡рд╢реНрдпрдХ');
┬а editMode='create'; $('#modalTitle').textContent='рдирдпрд╛ рд░рд┐рдХреЙрд░реНрдб'; clearForm(); openModal();
}
async function openEdit(id){
┬а if(!user) return alert('Login рдЖрд╡рд╢реНрдпрдХ');
┬а editMode='edit'; $('#modalTitle').textContent='рд░рд┐рдХреЙрд░реНрдб рдЕрдкрдбреЗрдЯ'; clearForm();
┬а const { data, error } = await sb.from('recovrybakimember').select('*').eq('id', id).single();
┬а if(error){ alert('Row fetch error: '+error.message); return; }
┬а $('#rowId').value = data.id;
┬а $('#f_adhar').value = data.adhar_number ?? '';
┬а $('#f_name').value = data.name ?? '';
┬а $('#f_father').value = data.father_name ?? '';
┬а $('#f_account').value = data.account_number ?? '';
┬а $('#f_amount').value = data.amount ?? '';
┬а $('#f_dmr').value = data.intrestdmr_number ?? '';
┬а $('#f_year').value = data.year ?? '';
┬а $('#f_done').value = data.recovery_done ? 'true' : 'false';
┬а openModal();
}

async function saveRecord(){
┬а if(!user) return alert('Login рдЖрд╡рд╢реНрдпрдХ');
┬а if(busy) return; if(!validateForm()) return; busy = true;
┬а const btn = $('#saveBtn'); const old = btn.textContent; btn.disabled = true; btn.textContent = 'рд╕реЗрд╡ рд╣реЛ рд░рд╣рд╛ рд╣реИ...';
┬а const payload = {
┬а ┬а adhar_number: $('#f_adhar').value.trim(),
┬а ┬а name: $('#f_name').value.trim(),
┬а ┬а father_name: $('#f_father').value.trim() || null,
┬а ┬а account_number: $('#f_account').value.trim() || null,
┬а ┬а amount: $('#f_amount').value ? Number($('#f_amount').value) : null,
┬а ┬а intrestdmr_number: $('#f_dmr').value.trim() || null,
┬а ┬а year: $('#f_year').value ? Number($('#f_year').value) : null,
┬а ┬а recovery_done: $('#f_done').value === 'true'
┬а };
┬а try{
┬а ┬а if(editMode==='create'){
┬а ┬а ┬а const { error } = await sb.from('recovrybakimember').insert(payload);
┬а ┬а ┬а if(error) throw error;
┬а ┬а }else{
┬а ┬а ┬а const id = $('#rowId').value;
┬а ┬а ┬а const { error } = await sb.from('recovrybakimember').update(payload).eq('id', id);
┬а ┬а ┬а if(error) throw error;
┬а ┬а }
┬а ┬а closeModal(); await loadData();
┬а }catch(e){ alert('Save error: '+(e.message||'unknown')); }
┬а finally{ btn.disabled=false; btn.textContent=old; busy=false; }
}

async function deleteRow(id){
┬а if(!user) return alert('Login рдЖрд╡рд╢реНрдпрдХ');
┬а if(!confirm('рд░рд┐рдХреЙрд░реНрдб рд╣рдЯрд╛рдПрдБ?')) return;
┬а const { error } = await sb.from('recovrybakimember').delete().eq('id', id);
┬а if(error){ alert('Delete error: '+error.message); return; }
┬а await loadData();
}
async function markDone(id){
┬а if(!user) return alert('Login рдЖрд╡рд╢реНрдпрдХ');
┬а const { error } = await sb.from('recovrybakimember').update({recovery_done:true}).eq('id', id);
┬а if(error){ alert('Mark done error: '+error.message); return; }
┬а await loadData();
}

/** ====== EVENTS ====== */
document.addEventListener('DOMContentLoaded', ()=>{
┬а // login ui
┬а $('#loginToggle').addEventListener('click', toggleLogin);
┬а $('#loginForm').addEventListener('submit', (e)=>{ e.preventDefault(); doLogin(); });
┬а $('#logoutBtn').addEventListener('click', doLogout);
┬а $('#topLogoutBtn').addEventListener('click', doLogout);

┬а // toolbar
┬а $('#refreshBtn').addEventListener('click', loadData);
┬а $('#addBtn').addEventListener('click', openCreate);

┬а // modal
┬а $('#cancelBtn').addEventListener('click', closeModal);
┬а $('#saveBtn').addEventListener('click', saveRecord);

┬а // table actions (delegation)
┬а $('#tbody').addEventListener('click', (e)=>{
┬а ┬а const btn = e.target.closest('button'); if(!btn) return;
┬а ┬а const id = btn.getAttribute('data-id');
┬а ┬а if(btn.classList.contains('edit')) return openEdit(id);
┬а ┬а if(btn.classList.contains('del')) return deleteRow(id);
┬а ┬а if(btn.classList.contains('mark')) return markDone(id);
┬а });

  // рдкреЗрдЬ рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдХреЛрдИ рднреА рдореМрдЬреВрджрд╛ рд╕реЗрд╢рди рддреБрд░рдВрдд рд╣реИрдВрдбрд▓ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ,
  // onAuthStateChange рдЗрд╕реЗ рд╕рдВрднрд╛рд▓ рд▓реЗрдЧрд╛ред рдЗрд╕рд▓рд┐рдП initial load block рдХреА рдЬрд░реВрд░рдд рдирд╣реАрдВред
});
</script>
</body>
</html>
