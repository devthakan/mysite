<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Download Filled ST Loan Form (Google Doc → PDF)</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body {
      background:
        radial-gradient(1200px 800px at 10% 10%, #22c55e26, transparent),
        radial-gradient(900px 700px at 90% 20%, #6366f122, transparent),
        #0b1220;
    }
    .glass { backdrop-filter: blur(14px); background: rgba(255,255,255,0.06); }
    .hidden { display:none; }
    .focusy:focus { outline:none; box-shadow: 0 0 0 3px rgba(34,197,94,.35); border-color: rgba(255,255,255,.25); }

    /* Loading Overlay */
    #loading_overlay { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center;
      background: rgba(2,6,23,.68); backdrop-filter: blur(6px); }
    #loading_overlay.show { display: flex; }
    .loader-card { background: rgba(15,23,42,.85); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 22px 24px; width: 320px; text-align: center; }
    .spinner { width: 48px; height: 48px; border: 4px solid rgba(255,255,255,.15); border-top-color: #22c55e; border-radius: 50%; margin: 0 auto 14px; animation: spin 0.9s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .progress { position: relative; height: 8px; background: rgba(255,255,255,.1); border-radius: 999px; overflow: hidden; margin-top: 12px; }
    .bar { position: absolute; inset: 0; width: 40%; background: linear-gradient(90deg,#22c55e,#a3e635,#22c55e); filter: saturate(1.2);
      animation: slide 1.3s ease-in-out infinite; }
    @keyframes slide { 0% { left:-40% } 50% { left:30% } 100% { left:100% } }

    /* Toast */
    #toast { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,.8); color:#fff; padding:10px 14px; border-radius:10px; display:none; }
    #toast.show { display:block; }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <div class="max-w-3xl mx-auto p-4 md:p-8">
    <header class="mb-6 md:mb-10">
      <h1 class="text-2xl md:text-3xl font-extrabold">Download Filled Form (PDF)</h1>
    </header>

    <section class="glass rounded-2xl p-6 md:p-8 border border-white/10 shadow-2xl">
      <div class="grid md:grid-cols-[1fr_auto] gap-3 md:items-end">
        <div>
          <label class="block text-sm mb-2">Application No. (आधार)</label>
          <input id="aadhaar_in" inputmode="numeric" maxlength="12" pattern="\d{12}"
                 class="w-full bg-slate-900/60 border border-white/10 rounded-xl p-3 focusy"
                 placeholder="12-digit Aadhaar"/>
        </div>
        <button id="btn_download" class="px-5 py-3 rounded-xl bg-emerald-500 text-slate-900 font-semibold hover:brightness-110">
          Download PDF
        </button>
      </div>
    </section>
  </div>

  <!-- Loading Overlay -->
  <div id="loading_overlay">
    <div class="loader-card">
      <div class="spinner"></div>
      <div class="text-slate-100 font-semibold">PDF तैयार हो रही है…</div>
      <div class="text-slate-400 text-sm mt-1">कृपया प्रतीक्षा करें</div>
      <div class="progress"><div class="bar"></div></div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";  // <-- अपना
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";                     // <-- अपना
    const APPLICATIONS = "applications";

    // तुम्हारा Google Doc template और Apps Script Web App (पहले से सही)
    const G_DOC_TEMPLATE_ID = "1iI2PkeJTZJXSKwEo4hM9JPzZv-aozQCd1-7JXCFryoA";
    const GDOC_WEBAPP_URL  = "https://script.google.com/macros/s/AKfycbzVji-kOog_eeLxa_VuIFVJMiNa3gxeWWsVGCvTz_BGAjLC9pYIc3BZ7QQBMlIjY6ewxw/exec";

    const PDF_NAME = (row) => `Loan_Application_${row.membership_no || row.aadhaar}.pdf`;

    /* ========= Helpers ========= */
    const $ = id => document.getElementById(id);
    const showToast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2600); };
    const overlayOn = ()=> $('loading_overlay').classList.add('show');
    const overlayOff = ()=> $('loading_overlay').classList.remove('show');

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function fetchRowByAadhaar(aadhaar){
      const q = await sb.from(APPLICATIONS)
        .select('*')
        .eq('aadhaar', aadhaar)
        .order('created_at', { ascending:false })
        .limit(1);
      if(q.error) throw q.error;
      return q.data?.[0] || null;
    }

    function buildPlaceholders(r){
      const base = {
        membership_no: r.membership_no || '',
        kisan_type: r.kisan_type || '',
        caste_cat: r.caste_cat || '',
        farmer_name: r.farmer_name || '',
        guardian_name: r.guardian_name || '',
        jaati: r.jaati || '',
        gender: r.gender || '',
        dob: r.dob || '',
        rev_village: r.rev_village || '',
        gram_panchayat: r.gram_panchayat || '',
        bank_ac: r.bank_ac || '',
        aadhaar: r.aadhaar || '',
        mobile: r.mobile || '',
        whatsapp: r.whatsapp || '',
        jan_aadhaar: r.jan_aadhaar || '',
        voter_id: r.voter_id || '',
        pan: (r.pan || '').toUpperCase(),
        nominee_name: r.nominee_name || '',
        nominee_dob: r.nominee_dob || '',
        nominee_relation: r.nominee_relation || '',
        w1_aadhaar: r.w1_aadhaar || '',
        w1_name: r.w1_name || '',
        w1_guardian_name: r.w1_guardian_name || '',
        w1_mobile: r.w1_mobile || '',
        w2_aadhaar: r.w2_aadhaar || '',
        w2_name: r.w2_name || '',
        w2_guardian_name: r.w2_guardian_name || '',
        w2_mobile: r.w2_mobile || '',
        date_today: new Date().toLocaleDateString('en-GB'),
        application_no: r.aadhaar || ''
      };
      const aliases = {};
      for (const [k,v] of Object.entries(base)){
        aliases[k.toUpperCase()] = v;
        aliases[k.replace(/_/g,'')] = v;
        aliases[k.split('_').map(s=>s[0].toUpperCase()+s.slice(1)).join('')] = v;
      }
      aliases['NAME'] = base.farmer_name;
      aliases['APPLICANT_NAME'] = base.farmer_name;
      aliases['FATHER_NAME'] = base.guardian_name;
      aliases['FATHER_HUSBAND_NAME'] = base.guardian_name;
      aliases['REVENUE_VILLAGE'] = base.rev_village;
      aliases['GRAM_PANCHAYAT'] = base.gram_panchayat;
      aliases['MOBILE_NO'] = base.mobile;
      aliases['WHATSAPP_NO'] = base.whatsapp;
      aliases['APPLICATION_NO'] = base.application_no;
      aliases['MEMBERSHIP_NO'] = base.membership_no;
      aliases['AADHAAR_NO'] = base.aadhaar;
      aliases['PAN_NO'] = base.pan;
      aliases['JAATI'] = base.jaati;
      return { ...base, ...aliases };
    }

    async function createPdfFromGDoc(placeholders, filename){
      // Content-Type 'text/plain' ताकि preflight से बचें
      const res = await fetch(GDOC_WEBAPP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({
          templateId: G_DOC_TEMPLATE_ID,
          data: placeholders,
          filename: filename || 'Loan_Application.pdf'
        })
      });
      let json;
      try { json = await res.json(); }
      catch (e) { throw new Error('INVALID_RESPONSE'); }
      if(!json.ok) throw new Error(json.error || 'PDF_FAILED');

      // base64 → Blob → Download
      const b64 = json.pdfBase64;
      const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
      const blob = new Blob([bytes], { type: 'application/pdf' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = json.filename || filename || 'Loan_Application.pdf';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function onDownloadClick(){
      const btn = $('btn_download');
      const aadhaar = $('aadhaar_in').value.trim();
      if(!/^\d{12}$/.test(aadhaar)){ showToast('कृपया 12 अंकों का आधार दर्ज करें'); return; }

      btn.disabled = true;
      overlayOn();

      try{
        // 1) Supabase से row
        const row = await fetchRowByAadhaar(aadhaar);
        if(!row){ throw new Error('RECORD_NOT_FOUND'); }

        // 2) placeholders
        const data = buildPlaceholders(row);
        const fname = PDF_NAME(row);

        // 3) Apps Script → PDF
        await createPdfFromGDoc(data, fname);

        // थोड़ा subtle delay ताकि यूआई स्मूद लगे
        await new Promise(r => setTimeout(r, 400));
        showToast('PDF तैयार ✔');
      }catch(e){
        console.error(e);
        const msg = (e.message==='RECORD_NOT_FOUND') ? 'रिकॉर्ड नहीं मिला' : 'PDF बनाने में समस्या';
        showToast(msg);
      }finally{
        overlayOff();
        btn.disabled = false;
      }
    }

    $('btn_download').addEventListener('click', onDownloadClick);
    $('aadhaar_in').addEventListener('keydown', e => {
      if(e.key === 'Enter'){ e.preventDefault(); onDownloadClick(); }
    });
  </script>
</body>
</html>
