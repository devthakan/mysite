<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>कानोड़ GSSS • रसीद बुक रिकवरी</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e9edf5;
    --accent1:#7c3aed; --accent2:#a855f7; --shadow:0 8px 24px rgba(2,6,23,.07);
    --r:16px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,"Noto Sans Devanagari",system-ui}
  .wrap{max-width:1200px;margin:18px auto;padding:0 18px}
  .panel{background:#fff;border:1px solid var(--border);border-radius:22px;box-shadow:var(--shadow);padding:18px}
  .head{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .title{font-size:32px;font-weight:800;margin:0}
  .tools{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
  .input,.btn{height:44px;border-radius:999px;border:1px solid var(--border);padding:0 14px;font:inherit;background:#fff}
  .btn{background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#fff;border:none;font-weight:700;cursor:pointer}
  .btn.ghost{background:#fff;color:#5b21b6;border:1px solid #e9d5ff}
  .table{width:100%;border-collapse:separate;border-spacing:0 14px;margin-top:14px}
  thead th{text-align:left;font-size:12px;color:var(--muted);padding:0 14px}
  tbody tr{background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow)}
  tbody td{padding:14px;border-bottom:1px solid #f2f4fb}
  tbody tr td:first-child{border-top-left-radius:16px;border-bottom-left-radius:16px}
  tbody tr td:last-child{border-top-right-radius:16px;border-bottom-right-radius:16px;border-bottom:none}
  .rec{height:40px;border:1px solid var(--border);border-radius:10px;padding:0 10px;width:130px;font:inherit;background:#fff}
  .save{height:40px;border:none;border-radius:10px;padding:0 14px;cursor:pointer;color:#fff;font-weight:700;background:linear-gradient(135deg,var(--accent2),var(--accent1))}
  .empty{padding:22px;border:1px dashed var(--border);border-radius:16px;text-align:center;color:#64748b;background:#fff}
  .flash{margin:10px 0;padding:10px 12px;border-radius:10px;font-size:14px;display:none}
  .flash.ok{background:#ecfdf5;color:#065f46;display:block}
  .flash.err{background:#fef2f2;color:#991b1b;display:block}
  .mini{font-size:12px;color:var(--muted)}
  .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
  .pg{border:1px solid var(--border);background:#fff;border-radius:10px;height:36px;padding:0 12px;cursor:pointer}
  .pg[disabled]{opacity:.5;cursor:not-allowed}
  /* Login modal */
  #authBox{display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); align-items:center; justify-content:center; z-index:50;}
  #authBox .card{background:#fff; border:1px solid var(--border); border-radius:16px; padding:18px; width:320px; box-shadow:0 8px 24px rgba(2,6,23,.15);}
  #authBox .card h3{margin:0 0 8px; font-weight:800}
  #authBox input{width:100%; height:40px; margin:8px 0; padding:0 10px; border:1px solid var(--border); border-radius:10px}
  #authBox button{width:100%; height:42px; border:none; color:#fff; font-weight:700; border-radius:10px; background:linear-gradient(135deg,#a855f7,#7c3aed)}
  #authBox .cancel{height:36px; margin-top:8px; border:1px solid var(--border); background:#fff; color:#0f172a}
</style>
</head>
<body>
<div class="wrap">
  <div class="panel">
    <div class="head">
      <h1 class="title">रसीद बुक रिकवरी</h1>
      <div class="tools">
        <input id="q" class="input" placeholder="खोजें… (id/name/mobile)">
        <select id="pageSize" class="input" style="width:120px">
          <option value="100">100</option>
          <option value="250" selected>250</option>
          <option value="500">500</option>
        </select>
        <button id="refresh" class="btn">रिफ्रेश</button>
        <button id="clear" class="btn ghost">क्लियर</button>
        <button id="btnLogin" class="btn ghost">लॉगिन</button>
        <button id="btnLogout" class="btn ghost" style="display:none">लॉगआउट</button>
      </div>
    </div>

    <div id="flash" class="flash"></div>
    <div id="count" class="mini" style="margin-top:6px"></div>
    <div id="tableWrap" style="margin-top:8px"></div>
    <div class="pagination">
      <button id="prev" class="pg" disabled>◀ Prev</button>
      <span id="pageInfo" class="mini"></span>
      <button id="next" class="pg" disabled>Next ▶</button>
    </div>
  </div>
</div>

<!-- Login Modal -->
<div id="authBox">
  <div class="card">
    <h3>Operator Login</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="doLogin">Login</button>
    <button id="closeAuth" class="cancel">Cancel</button>
    <div id="authMsg" class="mini" style="margin-top:6px"></div>
  </div>
</div>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.js"></script>
<script>
  /* ====== CONFIG (अपना भरें) ====== */
  const SUPABASE_URL = "https://sjfglhxjdyvcygunijvz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNqZmdsaHhqZHl2Y3lndW5panZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNDkyMDcsImV4cCI6MjA3MDgyNTIwN30.HduOuf_wdZ4iHHNN26ECilX_ALCHfnPPC07gYPN2tsM";
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ====== UI helpers ====== */
  const $ = (s)=>document.querySelector(s);
  const flash = (m='', t='') => { const f=$('#flash'); if(!m){f.style.display='none';return;} f.className='flash '+t; f.textContent=m; f.style.display='block'; setTimeout(()=>f.style.display='none',2200); };
  const showAuth = (v)=> $('#authBox').style.display = v ? 'flex' : 'none';
  function fmtCount(n){ return new Intl.NumberFormat('en-IN').format(n); }

  /* ====== Table/State ====== */
  const HEADERS = ["id","name","mobile","amount","recovery"];  // Supabase table columns
  let MASTER = [];        // current page rows
  let totalCount = 0;
  let page = 1;
  let pageSize = parseInt($('#pageSize').value, 10) || 250;

  function rowHtml(r){
    const cells = HEADERS.map(h => `<td>${r[h] ?? ''}</td>`).join('');
    const hint = r["recovery"] ?? "";
    return `<tr data-id="${r["id"]}">
      ${cells}
      <td><input class="rec" type="text" placeholder="${hint || 'राशि/नोट'}"></td>
      <td><button class="save">सेव</button></td>
    </tr>`;
  }

  function draw(list){
    if(!list.length){ $('#tableWrap').innerHTML = `<div class="empty">डेटा उपलब्ध नहीं</div>`; return; }
    const head = `<thead><tr>${HEADERS.map(h=>`<th>${h}</th>`).join('')}<th>रिकवरी</th><th></th></tr></thead>`;
    const body = list.map(rowHtml).join('');
    $('#tableWrap').innerHTML = `<table class="table">${head}<tbody>${body}</tbody></table>`;
    bindSave();
  }

  function applyFilter(){
    const q = ($('#q').value||'').toLowerCase();
    if(!q) { draw(MASTER); return; }
    const out = MASTER.filter(r => HEADERS.some(h => String(r[h]||'').toLowerCase().includes(q)));
    draw(out);
  }

  async function ensureLoggedIn(){
    const { data } = await supa.auth.getSession();
    if(!data.session){ showAuth(true); throw new Error('Please login'); }
    return true;
  }

  function bindSave(){
    document.querySelectorAll('.save').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const tr = e.target.closest('tr');
        const id = tr.dataset.id;
        const val = tr.querySelector('.rec').value.trim();
        if(!id || !val){ flash('वैल्यू दर्ज करें','err'); return; }
        try{
          await ensureLoggedIn();
          const { error } = await supa
            .from('receipts')
            .update({ recovery: isNaN(Number(val)) ? val : Number(val), updated_at: new Date().toISOString() })
            .eq('id', id);
          if(error) throw error;
          flash('सेव हो गया','ok');
          await load(); // refresh same page
        }catch(err){ flash(err.message,'err'); }
      });
    });
  }

  async function countAll(){
    const { count, error } = await supa
      .from('receipts')
      .select('id', { count: 'exact', head: true });
    if(error){ console.warn(error); return 0; }
    return count || 0;
  }

  async function load(){
    pageSize = parseInt($('#pageSize').value, 10) || 250;
    const from = (page-1)*pageSize;
    const to   = from + pageSize - 1;

    const { data, error } = await supa
      .from('receipts')
      .select(HEADERS.join(','), { count: 'exact' })
      .order('id', { ascending: true })
      .range(from, to);
    if(error){ flash(error.message, 'err'); return; }

    MASTER = data || [];
    totalCount = totalCount || (await countAll());
    $('#count').textContent = `Total: ${fmtCount(totalCount)} • Showing ${fmtCount(MASTER.length)} (Page ${page})`;
    $('#pageInfo').textContent = `Page ${page} of ${Math.max(1, Math.ceil(totalCount/pageSize))}`;

    // pagination buttons
    $('#prev').disabled = page <= 1;
    $('#next').disabled = (from + MASTER.length) >= totalCount;

    applyFilter();
  }

  // Pagination events
  $('#prev').onclick = ()=>{ if(page>1){ page--; load(); } };
  $('#next').onclick = ()=>{ const max = Math.ceil(totalCount/pageSize); if(page<max){ page++; load(); } };
  $('#pageSize').onchange = ()=>{ page=1; totalCount=0; load(); };

  // Search + buttons
  $('#q').addEventListener('input', applyFilter);
  $('#refresh').addEventListener('click', ()=>{ totalCount=0; load(); });
  $('#clear').addEventListener('click', ()=>{ $('#q').value=''; applyFilter(); });

  // Auth UI
  $('#btnLogin').onclick = ()=> showAuth(true);
  $('#closeAuth').onclick = ()=> showAuth(false);
  $('#doLogin').onclick = async ()=>{
    const email = $('#email').value.trim();
    const password = $('#password').value.trim();
    $('#authMsg').textContent = 'Logging in…';
    const { error } = await supa.auth.signInWithPassword({ email, password });
    if(error){ $('#authMsg').textContent = error.message; return; }
    $('#authMsg').textContent = 'Login successful';
    showAuth(false);
    refreshAuthUI();
  };
  $('#btnLogout').onclick = async ()=>{ await supa.auth.signOut(); refreshAuthUI(); };

  function refreshAuthUI(){
    supa.auth.getSession().then(({data})=>{
      const logged = !!data.session;
      $('#btnLogin').style.display  = logged ? 'none' : 'inline-block';
      $('#btnLogout').style.display = logged ? 'inline-block' : 'none';
    });
  }
  supa.auth.onAuthStateChange((_e,_s)=> refreshAuthUI());

  // Init
  (async ()=>{ refreshAuthUI(); await load(); })();
</script>
</body>
</html>
