<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>कानोड़ GSSS • रिकवरी</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --border:#e9edf5;
      --accent1:#7c3aed; --accent2:#a855f7; --accentDark:#5b21b6;
      --radius-xl:22px; --radius-lg:16px; --radius-md:12px;
      --shadow:0 8px 24px rgba(2,6,23,.07); --shadow-sm:0 4px 14px rgba(2,6,23,.06);
      --ok:#16a34a; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);
      font-family:Inter,"Noto Sans Devanagari",system-ui,-apple-system,Segoe UI,Roboto,Arial}
    /* Topbar — clean */
    .topbar{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.8);
      backdrop-filter:saturate(150%) blur(8px);border-bottom:1px solid var(--border)}
    .bar{max-width:1200px;margin:auto;padding:14px 18px;display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;letter-spacing:.2px;padding:10px 14px;background:#fff;border:1px solid var(--border);
      border-radius:999px;box-shadow:var(--shadow-sm)}
    .login{margin-left:auto;padding:10px 16px;border:none;border-radius:999px;color:#fff;font-weight:700;
      background:linear-gradient(135deg,var(--accent2),var(--accent1));box-shadow:0 8px 18px rgba(124,58,237,.25);cursor:pointer}

    /* Shell */
    .wrap{max-width:1200px;margin:18px auto;padding:0 18px}
    .panel{background:#fff;border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow);padding:18px}
    .head{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .title{font-size:32px;font-weight:800;margin:0}
    .tools{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
    .input,.btn{height:44px;border-radius:999px;border:1px solid var(--border);padding:0 14px;font:inherit;background:#fff}
    .btn{background:linear-gradient(135deg,var(--accent2),var(--accent1));color:#fff;border:none;font-weight:700;cursor:pointer;
      box-shadow:0 8px 18px rgba(124,58,237,.25)}
    .btn.ghost{background:#fff;color:var(--accentDark);border:1px solid #e9d5ff;box-shadow:var(--shadow-sm)}
    .subtle{margin-top:10px;font-size:12px;color:var(--muted)} /* छोटा टेक्स्ट, पर सिर्फ कॉलम नाम दिखाने हेतु */

    /* Table as cards */
    .table{width:100%;border-collapse:separate;border-spacing:0 14px;margin-top:14px}
    thead th{text-align:left;font-size:12px;color:var(--muted);padding:0 14px}
    tbody tr{background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow)}
    tbody td{padding:14px;border-bottom:1px solid #f2f4fb}
    tbody tr td:first-child{border-top-left-radius:var(--radius-lg);border-bottom-left-radius:var(--radius-lg)}
    tbody tr td:last-child{border-top-right-radius:var(--radius-lg);border-bottom-right-radius:var(--radius-lg);border-bottom:none}
    .rec{height:40px;border:1px solid var(--border);border-radius:10px;padding:0 10px;width:130px;font:inherit;background:#fff}
    .save{height:40px;border:none;border-radius:10px;padding:0 14px;cursor:pointer;color:#fff;font-weight:700;
      background:linear-gradient(135deg,var(--accent2),var(--accent1));box-shadow:0 8px 18px rgba(124,58,237,.25)}
    .empty{padding:22px;border:1px dashed var(--border);border-radius:var(--radius-lg);text-align:center;color:var(--muted);background:#fff}
    .flash{margin:10px 0;padding:10px 12px;border-radius:10px;font-size:14px;display:none}
    .flash.ok{background:#ecfdf5;color:#065f46;display:block}
    .flash.err{background:#fef2f2;color:#991b1b;display:block}
    .loading{opacity:.7;pointer-events:none}
    @media (max-width:900px){.title{font-size:26px}.tools{margin-left:0}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="bar">
      <div class="brand">कानोड़ GSSS</div>
      <button class="login" onclick="location.href='/'">लॉगिन</button>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="head">
        <h1 class="title">रसीद बुक रिकवरी</h1>
        <div class="tools">
          <input id="q" class="input" placeholder="खोजें…">
          <button id="refresh" class="btn">रिफ्रेश</button>
          <button id="clear" class="btn ghost">क्लियर</button>
        </div>
      </div>
      <div id="lastCol" class="subtle"></div>

      <div id="flash" class="flash"></div>
      <div id="tableWrap" style="margin-top:8px"></div>
    </div>
  </div>

  <script>
    /* === CONFIG === */
    const API_URL   = 'https://script.google.com/macros/s/AKfycbw4wS0hpMPp5UKfIm1jpNUJsy88JGdEtmRwS597DAbE8Vo8PjmUbdDa5GW9wzEqHlI/exec';
    const API_TOKEN = '123456789';

    /* === STATE === */
    let HEADERS = [];
    let ROWS = [];
    let LAST_COL_INDEX = null;
    let LAST_COL_NAME = null;

    const $ = s => document.querySelector(s);
    const flash = (msg='', type='') => {
      const box = $('#flash');
      if(!msg){ box.style.display='none'; return; }
      box.className = 'flash ' + type;
      box.textContent = msg;
      box.style.display = 'block';
      setTimeout(()=> (box.style.display='none'), 2500);
    };
    const setLoading = v => document.body.classList.toggle('loading', !!v);
    const clean = v => (v==null? '' : String(v).replace(/[&<>]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[s])));

    function drawTable(list){
      if(!list.length){
        $('#tableWrap').innerHTML = `<div class="empty">डेटा उपलब्ध नहीं है</div>`;
        return;
      }
      const head = `<thead><tr>${HEADERS.map(h=>`<th>${clean(h)}</th>`).join('')}<th>रिकवरी</th><th></th></tr></thead>`;
      const body = list.map(r=>{
        const row = HEADERS.map(h=>`<td>${clean(r[h])}</td>`).join('');
        const hint = clean(r[LAST_COL_NAME] ?? '');
        return `<tr data-row="${r._rowNumber}">
                  ${row}
                  <td><input class="rec" type="text" placeholder="${hint || 'राशि/नोट'}"></td>
                  <td><button class="save">सेव</button></td>
                </tr>`;
      }).join('');
      $('#tableWrap').innerHTML = `<table class="table">${head}<tbody>${body}</tbody></table>`;
      bindSave();
    }

    function bindSave(){
      document.querySelectorAll('.save').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const tr = e.target.closest('tr');
          const rowNumber = Number(tr.dataset.row);
          const val = tr.querySelector('.rec').value.trim();
          if(!val){ flash('वैल्यू दर्ज करें', 'err'); return; }

          try{
            setLoading(true);
            const res = await fetch(API_URL, {
              method: 'POST',
              headers: {'Content-Type':'text/plain'},
              body: JSON.stringify({ token: API_TOKEN, rowNumber, recovery: val })
            });
            const json = await res.json();
            if(json.ok){ flash('सेव हो गया', 'ok'); await load(); }
            else{ flash(json.error || 'त्रुटि', 'err'); }
          }catch(err){ flash(err.message, 'err'); }
          finally{ setLoading(false); }
        });
      });
    }

    async function load(){
      try{
        setLoading(true);
        const res = await fetch(API_URL + '?action=list');
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || 'API error');

        HEADERS = data.headers || [];
        ROWS = data.rows || [];
        LAST_COL_INDEX = data.lastColumnIndex;
        LAST_COL_NAME = data.lastColumnHeader || ('Col' + LAST_COL_INDEX);

        $('#lastCol').innerHTML = `शीट का आख़िरी कॉलम: <b>${clean(LAST_COL_NAME)}</b>`;
        applyFilter();
      }catch(err){
        $('#tableWrap').innerHTML = `<div class="empty">${clean(err.message)}</div>`;
      }finally{
        setLoading(false);
      }
    }

    function applyFilter(){
      const q = ($('#q').value||'').toLowerCase();
      if(!q) return drawTable(ROWS);
      const keys = HEADERS;
      const out = ROWS.filter(r => keys.some(h => String(r[h]||'').toLowerCase().includes(q)));
      drawTable(out);
    }

    // Events
    $('#q').addEventListener('input', applyFilter);
    $('#refresh').addEventListener('click', load);
    $('#clear').addEventListener('click', ()=>{ $('#q').value=''; applyFilter(); });

    // Init
    load();
  </script>
</body>
</html>
